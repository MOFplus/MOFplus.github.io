

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>molsys.mol &mdash; molsys 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> molsys
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user_quickstart.html">1. Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user_addon.html">2. Addons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user_util.html">3. Utility Modules</a></li>
</ul>
<p class="caption"><span class="caption-text">Technical Stuff</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tech_api.html">1. API Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">File Formats</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../file_io.html">1. File Formats</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">molsys</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>molsys.mol</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for molsys.mol</h1><div class="highlight"><pre>
<span></span><span class="c1">#-*- coding: utf-8 -*-</span>
<span class="c1">### overload print in parallel case (needs to be the first line) [RS] ###</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1">#from scipy.optimize import linear_sum_assignment as hungarian</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">unit_cell</span>
<span class="kn">from</span> <span class="nn">.util.units</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">elems</span> <span class="k">as</span> <span class="n">elements</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">rotations</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">images</span>
<span class="kn">from</span> <span class="nn">.util.images</span> <span class="kn">import</span> <span class="n">arr2idx</span><span class="p">,</span> <span class="n">idx2arr</span><span class="p">,</span> <span class="n">idx2revidx</span>
<span class="kn">from</span> <span class="nn">.util.misc</span> <span class="kn">import</span> <span class="n">argsorted</span>
<span class="kn">from</span> <span class="nn">.util.color</span> <span class="kn">import</span> <span class="n">vcolor2elem</span>

<span class="kn">from</span> <span class="nn">.fileIO</span> <span class="kn">import</span> <span class="n">formats</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">mpiobject</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">molsys_mpi</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">addon</span>
<span class="kn">from</span> <span class="nn">.prop</span> <span class="kn">import</span> <span class="n">Property</span>

<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">reaxparam</span>

<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

<span class="kn">import</span> <span class="nn">math</span>

<span class="c1"># set up logging using a logger</span>
<span class="c1"># note that this is module level because there is one logger for molsys</span>
<span class="c1"># DEBUG/LOG goes to logfile, whereas WARNIGNS/ERRORS go to stdout</span>
<span class="c1">#</span>
<span class="c1"># NOTE: this needs to be done once only here for the root logger molsys</span>
<span class="c1"># any other module can use either this logger or a child logger</span>
<span class="c1"># no need to redo this config in the other modules!</span>
<span class="c1"># NOTE2: in a parallel run all DEBUG is written by all nodes whereas only the</span>
<span class="c1">#        master node writes INFO to stdout</span>
<span class="c1"># TBI: colored logging https://stackoverflow.com/a/384125</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span>
<span class="n">logger</span>    <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;molsys&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="k">if</span> <span class="n">molsys_mpi</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">logger_file_name</span> <span class="o">=</span> <span class="s2">&quot;molsys.</span><span class="si">%d</span><span class="s2">.log&quot;</span> <span class="o">%</span> <span class="n">molsys_mpi</span><span class="o">.</span><span class="n">rank</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">logger_file_name</span> <span class="o">=</span> <span class="s2">&quot;molsys.log&quot;</span>
<span class="c1"># check if environment variable MOLSYS_LOG is set</span>
<span class="k">if</span> <span class="s2">&quot;MOLSYS_LOG&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
    <span class="n">fhandler</span>  <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">logger_file_name</span><span class="p">)</span>
    <span class="c1"># TBI if os.environ[&quot;MOLSYS_LOG&quot;] in (&quot;DEBUG&quot;, &quot;WARNING&quot;, &quot;INFO&quot;):</span>
    <span class="n">fhandler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="c1">#fhandler.setLevel(logging.WARNING)</span>
    <span class="n">fhandler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">fhandler</span><span class="p">)</span>
<span class="k">if</span> <span class="n">molsys_mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">shandler</span>  <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="n">shandler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="c1">#shandler.setLevel(logging.WARNING)</span>
    <span class="n">shandler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">shandler</span><span class="p">)</span>

<span class="k">if</span> <span class="n">molsys_mpi</span><span class="o">.</span><span class="n">wcomm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;MPI NOT IMPORTED DUE TO ImportError&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">molsys_mpi</span><span class="o">.</span><span class="n">err</span><span class="p">)</span>

<span class="c1"># overload print function in parallel case</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">__builtin__</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">builtins</span> <span class="k">as</span> <span class="nn">__builtin__</span>
<div class="viewcode-block" id="print"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.print">[docs]</a><span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">molsys_mpi</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">__builtin__</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span></div>


<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mi">20000</span><span class="p">,</span><span class="n">precision</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">SMALL_DIST</span> <span class="o">=</span> <span class="mf">1.0e-3</span>


<div class="viewcode-block" id="mol"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol">[docs]</a><span class="k">class</span> <span class="nc">mol</span><span class="p">(</span><span class="n">mpiobject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;mol class, the basis for any atomistic (or atomistic-like,</span>
<span class="sd">    e.g. topo) representation.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpi_comm</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">mpi_comm</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbonds</span><span class="o">=</span><span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellparams</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inv_cell</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images_cellvec</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcond</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elems</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atypes</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amass</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctab</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fragtypes</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span><span class="o">=</span><span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfrags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="o">=</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_addons</span> <span class="o">=</span>  <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_logger_level</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pimages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ptab</span>  <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">supercell</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aprops</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bprops</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_etab</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_bb</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_topo</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># this flag replaces the old topo object derived from mol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># extra flag .. we could have toper that do not need pconn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masstype</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span>

    <span class="c1"># for future python3 compatibility</span>
    <span class="c1"># TODO: mpicomm compatibility?</span>
    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shallow copy as for the standard copy.copy function</span>
<span class="sd">        To be tested with python3</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span> <span class="c1">#python3 # check</span>
            <span class="n">newone</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="vm">__class__</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span> <span class="c1">#python2</span>
            <span class="n">newone</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
        <span class="n">newdict</span> <span class="o">=</span> <span class="n">newone</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="n">newdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">newdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">newdict</span><span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># if not copiable</span>
                <span class="n">newdict</span><span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">newone</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deep copy as for the standard copy.deepcopy function</span>
<span class="sd">        To be tested with python3</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span> <span class="c1">#python3 # check</span>
            <span class="n">newone</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="vm">__class__</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span> <span class="c1">#python2</span>
            <span class="n">newone</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
        <span class="n">newdict</span> <span class="o">=</span> <span class="n">newone</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="n">newdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">newdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">newdict</span><span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">memo</span><span class="p">)]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># if not deep-copiable</span>
                <span class="n">newdict</span><span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">memo</span><span class="p">)]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">newone</span>

<div class="viewcode-block" id="mol.clone"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.clone">[docs]</a>    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clone molecule</span>
<span class="sd">        Here as convenience method instead of copy.deepcopy</span>

<span class="sd">        :Return:</span>
<span class="sd">        - self (mol): cloned molecule</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="c1">#####  I/O stuff ######################################################################################</span>

<div class="viewcode-block" id="mol.set_logger_level"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_logger_level">[docs]</a>    <span class="k">def</span> <span class="nf">set_logger_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;WARNING&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">level</span><span class="o">==</span><span class="s1">&#39;INFO&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">level</span><span class="o">==</span><span class="s1">&#39;WARNING&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">level</span><span class="o">==</span><span class="s1">&#39;ERROR&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">level</span><span class="o">==</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.read"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; generic reader for the mol class</span>
<span class="sd">        Parameters:</span>
<span class="sd">            fname(str)   : the filename to be read or a generic name</span>
<span class="sd">            ftype(str)   : the parser type that is used to read the file (default: &quot;mfpx&quot;)</span>
<span class="sd">            **kwargs     : all options of the parser are passed by the kwargs</span>
<span class="sd">                             see molsys.io.* for detailed info&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span>
        <span class="k">if</span> <span class="n">ftype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fsplit</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">fsplit</span> <span class="o">!=</span> <span class="n">fname</span><span class="p">:</span> <span class="c1">#there is an extension</span>
                <span class="n">ftype</span> <span class="o">=</span> <span class="n">fsplit</span> <span class="c1">#ftype is inferred from extension</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#there is no extension</span>
                <span class="n">ftype</span> <span class="o">=</span> <span class="s1">&#39;mfpx&#39;</span> <span class="c1">#default</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;reading file </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2"> format&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ftype</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the file </span><span class="si">%s</span><span class="s1"> does not exist, trying with extension </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">ftype</span><span class="p">)))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">ftype</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;the file </span><span class="si">%s</span><span class="s1"> does not exist&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="n">formats</span><span class="o">.</span><span class="n">read</span><span class="p">:</span>
            <span class="n">formats</span><span class="o">.</span><span class="n">read</span><span class="p">[</span><span class="n">ftype</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;unsupported format: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ftype</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Unsupported format&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.from_smiles"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.from_smiles">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_smiles</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">smile</span><span class="p">,</span> <span class="n">bbcenter</span><span class="o">=</span><span class="s1">&#39;com&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">ff</span><span class="o">=</span><span class="s2">&quot;mmff94&quot;</span><span class="p">,</span> <span class="n">confsearch</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; generates mol object from smiles string, requires openbabel to be installed</span>

<span class="sd">        use a conformational search by default</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">ff</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;UFF&quot;</span><span class="p">,</span> <span class="s2">&quot;mmff94&quot;</span><span class="p">]</span>   <span class="c1"># add other potential openbabel ffs</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">openbabel</span> <span class="kn">import</span> <span class="n">pybel</span>
            <span class="kn">from</span> <span class="nn">openbabel</span> <span class="kn">import</span> <span class="n">OBForceField</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="kn">import</span> <span class="nn">traceback</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;install openbabel 3.0 from github&#39;</span><span class="p">)</span>
        <span class="c1">#if bbconn != []:</span>
        <span class="c1">#    nconns = len(bbconn)</span>
        <span class="c1">#    dummies = [&#39;He&#39;,&#39;Ne&#39;,&#39;Ar&#39;,&#39;Kr&#39;,&#39;Xe&#39;,&#39;Rn&#39;]</span>
        <span class="c1">#    for i,c in enumerate(bbconn):</span>
        <span class="c1">#        smile = smile.replace(c,dummies[i])</span>
        <span class="n">om</span> <span class="o">=</span> <span class="n">pybel</span><span class="o">.</span><span class="n">readstring</span><span class="p">(</span><span class="s2">&quot;smi&quot;</span><span class="p">,</span> <span class="n">smile</span><span class="p">)</span>
        <span class="n">om</span><span class="o">.</span><span class="n">make3D</span><span class="p">(</span><span class="n">forcefield</span><span class="o">=</span><span class="s1">&#39;UFF&#39;</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">maxiter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">confsearch</span><span class="p">:</span>
            <span class="n">ff</span> <span class="o">=</span> <span class="n">OBForceField</span><span class="o">.</span><span class="n">FindForceField</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">om</span><span class="o">.</span><span class="n">OBMol</span><span class="p">)</span>
            <span class="n">ie</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">Energy</span><span class="p">()</span>
            <span class="c1"># ToDo ..add more options on conformational search here</span>
            <span class="c1"># how to tell the user? logger or print?</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">WeightedRotorSearch</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">25</span><span class="p">)</span>
            <span class="n">fe</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">Energy</span><span class="p">()</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">UpdateCoordinates</span><span class="p">(</span><span class="n">om</span><span class="o">.</span><span class="n">OBMol</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Conformational search performed. intital </span><span class="si">%12.6f</span><span class="s2"> final </span><span class="si">%12.6f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="n">fe</span><span class="p">))</span>
        <span class="n">txyzs</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;txyz&#39;</span><span class="p">)</span>
        <span class="c1"># there is gibberish in the first line of the txyzstring, we need to remove it!</span>
        <span class="n">txyzsl</span> <span class="o">=</span> <span class="n">txyzs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">txyzsl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">txyzsl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">txyzs</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">txyzsl</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">txyzs</span><span class="p">,</span><span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;txyz&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">smile</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">addon</span><span class="p">(</span><span class="s1">&#39;bb&#39;</span><span class="p">)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">bb</span><span class="o">.</span><span class="n">add_bb_info</span><span class="p">(</span><span class="n">conn_identifier</span><span class="o">=</span> <span class="s1">&#39;xx&#39;</span><span class="p">,</span><span class="n">center_point</span><span class="o">=</span><span class="n">bbcenter</span><span class="p">)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">bb</span><span class="o">.</span><span class="n">center</span><span class="p">()</span>
        <span class="kn">import</span> <span class="nn">molsys.util.atomtyper</span> <span class="k">as</span> <span class="nn">atomtyper</span>
        <span class="n">at</span> <span class="o">=</span> <span class="n">atomtyper</span><span class="p">(</span><span class="n">m</span><span class="p">);</span> <span class="n">at</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">m</span></div>

<div class="viewcode-block" id="mol.from_file"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.from_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; reader for the mol class, reading from a file</span>
<span class="sd">        Parameters:</span>
<span class="sd">            fname(str): path to the file (filename included)</span>
<span class="sd">            ftype=None (or str): the parser type that is used to read the file</span>
<span class="sd">                if None: assigned by read as mfpx (default)</span>
<span class="sd">            **kwargs     : all options of the parser are passed by the kwargs</span>
<span class="sd">                             see molsys.io.* for detailed info&#39;&#39;&#39;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ftype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span></div>

<div class="viewcode-block" id="mol.from_string"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.from_string">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_string</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">istring</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;mfpx&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; generic reader for the mol class, reading from a string</span>
<span class="sd">        Parameters:</span>
<span class="sd">            string       : the string to be read</span>
<span class="sd">            ftype=&quot;mfpx&quot; : the parser type that is used to read the file</span>
<span class="sd">            **kwargs     : all options of the parser are passed by the kwargs</span>
<span class="sd">                             see molsys.io.* for detailed info&#39;&#39;&#39;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;reading string as </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">ftype</span><span class="p">))</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">istring</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="n">formats</span><span class="o">.</span><span class="n">read</span><span class="p">:</span>
            <span class="n">formats</span><span class="o">.</span><span class="n">read</span><span class="p">[</span><span class="n">ftype</span><span class="p">](</span><span class="n">m</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;unsupported format: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ftype</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Unsupported format&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span></div>

<div class="viewcode-block" id="mol.from_fileobject"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.from_fileobject">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_fileobject</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;mfpx&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; generic reader for the mol class, reading from a string</span>
<span class="sd">        Parameters:</span>
<span class="sd">            string       : the string to be read</span>
<span class="sd">            ftype=&quot;mfpx&quot; : the parser type that is used to read the file</span>
<span class="sd">            **kwargs     : all options of the parser are passed by the kwargs</span>
<span class="sd">                             see molsys.io.* for detailed info&#39;&#39;&#39;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;reading string as </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">ftype</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="n">formats</span><span class="o">.</span><span class="n">read</span><span class="p">:</span>
            <span class="n">formats</span><span class="o">.</span><span class="n">read</span><span class="p">[</span><span class="n">ftype</span><span class="p">](</span><span class="n">m</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;unsupported format: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ftype</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Unsupported format&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span></div>



<div class="viewcode-block" id="mol.from_abinit"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.from_abinit">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_abinit</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">elems</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">frac</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">detect_conn</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;reading basic data provided by any AbInitio programm&#39;</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_elems</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_atypes</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">frac</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">set_xyz_from_frac</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">set_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_nofrags</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_empty_conn</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">detect_conn</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">detect_conn</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">m</span></div>

<div class="viewcode-block" id="mol.from_pymatgen"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.from_pymatgen">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_pymatgen</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;creating mol object from a pymatgen structure object&#39;</span><span class="p">)</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">matrix</span>
        <span class="n">fracs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">elems</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">sites</span><span class="p">):</span>
            <span class="c1">### elems.append(site.species.symbol.lower())  </span>
            <span class="c1"># JK: This line is gone with the tested version (2020.1.10). It is because Periodic sites can now be occupied </span>
            <span class="c1"># not only by a single atom, but by more atoms. This is why there is now lists of things instead of a single atom</span>
            <span class="c1"># I replaced this as follows, where I still keep the single atom definition:</span>
            <span class="c1"># If ever needed, this has to be replaced by a loop, and it has to be taken care of where the position of those </span>
            <span class="c1"># multiple atoms is w.r.t. to the position of the periodic site.</span>
            <span class="c1">###</span>
            <span class="n">elems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="n">fracs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">site</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">site</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">site</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
        <span class="n">fracs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fracs</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">natoms</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_elems</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_atypes</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_xyz_from_frac</span><span class="p">(</span><span class="n">fracs</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_nofrags</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_empty_conn</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">detect_conn</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">m</span></div>

<div class="viewcode-block" id="mol.from_ff"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.from_ff">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_ff</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">fit</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">basename</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">addon</span><span class="p">(</span><span class="s2">&quot;ff&quot;</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">ff</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">fit</span> <span class="o">=</span> <span class="n">fit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span></div>


<div class="viewcode-block" id="mol.from_array"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.from_array">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_array</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; generic reader for the mol class, reading from a Nx3 array</span>
<span class="sd">        Parameters:</span>
<span class="sd">            arr         : the array to be read</span>
<span class="sd">            **kwargs    : all options of the parser are passed by the kwargs</span>
<span class="sd">                             see molsys.io.* for detailed info&#39;&#39;&#39;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;reading array&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;Wrong array dimension (second must be 3): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">,)</span>
        <span class="n">formats</span><span class="o">.</span><span class="n">read</span><span class="p">[</span><span class="s1">&#39;array&#39;</span><span class="p">](</span><span class="n">m</span><span class="p">,</span><span class="n">arr</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span></div>

<div class="viewcode-block" id="mol.from_nested_list"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.from_nested_list">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_nested_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">nestl</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; generic reader for the mol class, reading from a Nx3 array</span>
<span class="sd">        Parameters:</span>
<span class="sd">            arr         : the array to be read</span>
<span class="sd">            **kwargs    : all options of the parser are passed by the kwargs</span>
<span class="sd">                             see molsys.io.* for detailed info&#39;&#39;&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;reading nested lists&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nl</span> <span class="ow">in</span> <span class="n">nestl</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">nl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;Wrong nested list lenght (must be 3): </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">,)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nestl</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">fromArray</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="mol.from_cp2k_restart"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.from_cp2k_restart">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_cp2k_restart</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">restart</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; reads and parses a cp2k restart file</span>
<span class="sd">        Parameters:</span>
<span class="sd">            restart     : restart filename</span>
<span class="sd">            **kwargs    : all options of the parser are passed by the kwargs</span>
<span class="sd">                             see molsys.io.* for detailed info&#39;&#39;&#39;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">restart</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c1"># coords</span>
        <span class="n">xyz_str</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">txt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&amp;COORD&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;&amp;END COORD&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">elems</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xyz_str</span><span class="p">]</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xyz_str</span><span class="p">])</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">txt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&amp;CELL</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&amp;END CELL</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]])</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">cp2ktxt</span> <span class="o">=</span> <span class="n">txt</span>
        <span class="n">m</span><span class="o">.</span><span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_xyz</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">cell_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">elems</span> <span class="o">=</span> <span class="n">elems</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_nofrags</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">detect_conn</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">atypes</span> <span class="o">=</span> <span class="n">elems</span>
        <span class="k">return</span> <span class="n">m</span> </div>

<div class="viewcode-block" id="mol.from_systrekey"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.from_systrekey">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_systrekey</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">skey</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;generate a mol/topo object from a systrekey as the barycentric embedding</span>

<span class="sd">        it is necessary to have graph_tool installed in order to run lqg</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            skey (string): the systrekey</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.util.lqg</span> <span class="kn">import</span> <span class="n">lqg</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">lqg</span><span class="p">()</span>
        <span class="n">l</span><span class="o">.</span><span class="n">read_systre_key</span><span class="p">(</span><span class="n">skey</span><span class="p">)</span>
        <span class="n">l</span><span class="p">()</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">natoms</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">nvertices</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_xyz_from_frac</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">frac_xyz</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_empty_conn</span><span class="p">()</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_empty_pconn</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">edges</span><span class="p">):</span>
            <span class="n">m</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">m</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">m</span><span class="o">.</span><span class="n">pconn</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">m</span><span class="o">.</span><span class="n">pconn</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="c1"># TODO: set types properly</span>
        <span class="n">m</span><span class="o">.</span><span class="n">set_atypes</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">nvertices</span><span class="o">*</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">elements</span><span class="o">.</span><span class="n">topotypes</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span>
            <span class="n">m</span><span class="o">.</span><span class="n">elems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">is_topo</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">m</span><span class="o">.</span><span class="n">use_pconn</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">m</span></div>

<div class="viewcode-block" id="mol.from_pdlp"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.from_pdlp">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_pdlp</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">traj</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;generate mol object from pdlp file</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            fname (string): name of pdlp file</span>
<span class="sd">            stage (string): stage name</span>
<span class="sd">            traj (bool, optional): if a trajectory info is present load addon and set source. Defaults to True.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            molobejct: generated mol object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">molsys.util</span> <span class="kn">import</span> <span class="n">pdlpio2</span>
        <span class="c1"># instantiate the pdlpio2 reader</span>
        <span class="n">pio</span> <span class="o">=</span> <span class="n">pdlpio2</span><span class="o">.</span><span class="n">pdlpio2</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">restart</span><span class="o">=</span><span class="n">stage</span><span class="p">,</span> <span class="n">filemode</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="c1"># get the mol obejct from the pdlp file</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">pio</span><span class="o">.</span><span class="n">get_mol_from_system</span><span class="p">()</span>
        <span class="n">pio</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">traj</span><span class="p">:</span>
            <span class="n">m</span><span class="o">.</span><span class="n">addon</span><span class="p">(</span><span class="s2">&quot;traj&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;pdlp&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span> <span class="n">stage</span><span class="o">=</span><span class="n">stage</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span></div>


<div class="viewcode-block" id="mol.to_phonopy"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.to_phonopy">[docs]</a>    <span class="k">def</span> <span class="nf">to_phonopy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hessian</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Method to create a phonopy object for lattice dynamic calculations.</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            hessian (numpy.ndarray, optional): Defaults to None. Hessian matrix of</span>
<span class="sd">                shape (3N,3N) in kcal/mol/A**2.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ImportError: Raises Import Error when phonopy is not installed</span>

<span class="sd">        Returns:</span>
<span class="sd">            [Phonopy]: Return the phonopy object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">phonopy</span> <span class="kn">import</span> <span class="n">Phonopy</span>
            <span class="kn">from</span> <span class="nn">phonopy.structure.atoms</span> <span class="kn">import</span> <span class="n">PhonopyAtoms</span>
            <span class="kn">from</span> <span class="nn">phonopy.units</span> <span class="kn">import</span> <span class="n">ElkToTHz</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Phonopy is not available!&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="o">==</span> <span class="kc">True</span><span class="p">;</span> <span class="s2">&quot;Requested system is not periodic!&quot;</span>
        <span class="n">unitcell</span> <span class="o">=</span> <span class="n">PhonopyAtoms</span><span class="p">(</span><span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elems</span><span class="p">()],</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(),</span> <span class="n">scaled_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_frac_from_xyz</span><span class="p">())</span>
        <span class="c1"># phonopy is setup by assuming atomic units for the hessian matrix</span>
        <span class="n">phonon</span> <span class="o">=</span> <span class="n">Phonopy</span><span class="p">(</span><span class="n">unitcell</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span> <span class="n">factor</span> <span class="o">=</span> <span class="n">ElkToTHz</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hessian</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># we convert here the hessian to the phonopy format and  to atomic units</span>
            <span class="n">hessian</span> <span class="o">*=</span> <span class="n">kcalmol</span><span class="o">/</span><span class="n">angstrom</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">h2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;double&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
                    <span class="n">i3</span><span class="p">,</span><span class="n">j3</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">j</span>
                    <span class="n">h2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">hessian</span><span class="p">[</span><span class="n">i3</span><span class="p">:</span><span class="n">i3</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="n">j3</span><span class="p">:</span><span class="n">j3</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">phonon</span><span class="o">.</span><span class="n">set_force_constants</span><span class="p">(</span><span class="n">h2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phonon</span></div>

<div class="viewcode-block" id="mol.write"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; generic writer for the mol class</span>
<span class="sd">        Parameters:</span>
<span class="sd">            fname        : the filename to be written</span>
<span class="sd">            ftype=&quot;mfpx&quot; : the parser type that is used to writen the file</span>
<span class="sd">            rank         : deault: None, if not None but integer write if rank = 0 (e.g. we use partitions, then rank is partition rank)</span>
<span class="sd">            **kwargs     : all options of the parser are passed by the kwargs</span>
<span class="sd">                             see molsys.io.* for detailed info&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if rank is given return only when rank is not zero (mpi_rank can be nonzero!)</span>
            <span class="k">if</span> <span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># otherise use mpi_rank</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_rank</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="n">ftype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fsplit</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">fsplit</span> <span class="o">!=</span> <span class="n">fname</span><span class="p">:</span> <span class="c1">#there is an extension</span>
                <span class="n">ftype</span> <span class="o">=</span> <span class="n">fsplit</span> <span class="c1">#ftype is inferred from extension</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#there is no extension</span>
                <span class="n">ftype</span> <span class="o">=</span> <span class="s1">&#39;mfpx&#39;</span> <span class="c1">#default</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;writing file &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; in &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ftype</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; format&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="n">formats</span><span class="o">.</span><span class="n">write</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">formats</span><span class="o">.</span><span class="n">write</span><span class="p">[</span><span class="n">ftype</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;unsupported format: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ftype</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Unsupported format&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.to_string"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.to_string">[docs]</a>    <span class="k">def</span> <span class="nf">to_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;mfpx&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to output mol object as string in the format</span>
<span class="sd">        of the given filetype.</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            ftype(string): name of the filetype, default to mfpx</span>

<span class="sd">        Raises:</span>
<span class="sd">            IOError</span>

<span class="sd">        Returns:</span>
<span class="sd">            string: mol object as string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;writing string as </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">ftype</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="n">formats</span><span class="o">.</span><span class="n">write</span><span class="p">:</span>
            <span class="n">formats</span><span class="o">.</span><span class="n">write</span><span class="p">[</span><span class="n">ftype</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;unsupported format: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ftype</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Unsupported format&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span></div>

<div class="viewcode-block" id="mol.to_fileobject"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.to_fileobject">[docs]</a>    <span class="k">def</span> <span class="nf">to_fileobject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="p">,</span> <span class="n">ftype</span> <span class="o">=</span><span class="s2">&quot;mfpx&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;writing string as </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">ftype</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="n">formats</span><span class="o">.</span><span class="n">write</span><span class="p">:</span>
            <span class="n">formats</span><span class="o">.</span><span class="n">write</span><span class="p">[</span><span class="n">ftype</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;unsupported format: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ftype</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Unsupported format&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span></div>

<div class="viewcode-block" id="mol.view"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.view">[docs]</a>    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;txyz&#39;</span><span class="p">,</span> <span class="n">program</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; launch graphics visualisation tool, i.e. moldenx.</span>
<span class="sd">        Debugging purpose.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;invoking </span><span class="si">%s</span><span class="s2"> as visualisation tool&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">program</span><span class="p">,))</span>
            <span class="n">pid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
            <span class="n">_tmpfname</span> <span class="o">=</span> <span class="s2">&quot;_tmpfname_</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">ftype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_tmpfname</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="n">ftype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">program</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">program</span> <span class="o">=</span> <span class="s2">&quot;moldenx&quot;</span>
            <span class="k">if</span> <span class="n">opts</span> <span class="o">==</span> <span class="p">()</span> <span class="ow">and</span> <span class="n">program</span> <span class="o">==</span> <span class="s2">&quot;moldenx&quot;</span><span class="p">:</span>
                <span class="n">opts</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;-a&#39;</span><span class="p">,</span> <span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="s1">&#39;-S&#39;</span><span class="p">,</span> <span class="s1">&#39;-hoff&#39;</span><span class="p">,</span> <span class="s1">&#39;-geom&#39;</span><span class="p">,</span> <span class="s1">&#39;1080x1080&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="n">program</span><span class="p">,</span> <span class="n">_tmpfname</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">opts</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">_tmpfname</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;temporary file &quot;</span><span class="o">+</span><span class="n">_tmpfname</span><span class="o">+</span><span class="s2">&quot; removed&quot;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;temporary file &quot;</span><span class="o">+</span><span class="n">_tmpfname</span><span class="o">+</span><span class="s2">&quot; removed during view!&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.molden"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.molden">[docs]</a>    <span class="k">def</span> <span class="nf">molden</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">opts</span> <span class="o">==</span> <span class="p">():</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;-a&#39;</span><span class="p">,</span> <span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="s1">&#39;-S&#39;</span><span class="p">,</span> <span class="s1">&#39;-hoff&#39;</span><span class="p">,</span> <span class="s1">&#39;-geom&#39;</span><span class="p">,</span> <span class="s1">&#39;1080x1080&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;txyz&#39;</span><span class="p">,</span> <span class="n">program</span><span class="o">=</span><span class="s1">&#39;moldenx&#39;</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="n">opts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="mol.pymol"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.pymol">[docs]</a>    <span class="k">def</span> <span class="nf">pymol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpi_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;txyz&#39;</span><span class="p">,</span> <span class="n">program</span><span class="o">=</span><span class="s1">&#39;pymol&#39;</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="n">opts</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="c1">##### addons ####################################################################################</span>

<div class="viewcode-block" id="mol.addon"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.addon">[docs]</a>    <span class="k">def</span> <span class="nf">addon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addmod</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        add an addon module to this object</span>
<span class="sd">        the adddon will be an instance of the addon class and available as attribute of mol instance</span>

<span class="sd">        Args:</span>
<span class="sd">            addmod (string): string name of the addon module</span>
<span class="sd">            *args          : positional arguments for the addon instantiator</span>
<span class="sd">            **kwargs       :    keyword arguments for the addon instantiator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">addmod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_addons</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> addon is already available as attribute of mol instance!&quot;</span> <span class="o">%</span> <span class="n">addmod</span><span class="p">)</span>
            <span class="n">loaded</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="n">loaded</span>
        <span class="k">if</span> <span class="n">addmod</span> <span class="ow">in</span> <span class="n">addon</span><span class="o">.</span><span class="n">__all__</span><span class="p">:</span> <span class="c1">### addon is enabled: try to set it</span>
            <span class="n">addclass</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">addon</span><span class="p">,</span> <span class="n">addmod</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">addclass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1">### no error raised during addon/__init__.py import</span>
                <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">addclass</span><span class="p">):</span>
                    <span class="c1">### get the addon attribute, initialize it and set as self attribute</span>
                    <span class="n">addinst</span> <span class="o">=</span> <span class="n">addclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addmod</span><span class="p">,</span> <span class="n">addinst</span><span class="p">)</span>
                    <span class="n">loaded</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">### the addon is now available as self.addmod</span>
                <span class="k">elif</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismodule</span><span class="p">(</span><span class="n">addclass</span><span class="p">):</span>
                    <span class="c1">### to enable syntax: &#39;from molsys.addon.addmod import addmod&#39;</span>
                    <span class="c1"># in this case, e.g.: addon.ff is the MODULE, not the CLASS, so that we need TWICE</span>
                    <span class="c1"># the &#39;getattr&#39; to get molsys.addon.ff.ff</span>
                    <span class="n">addclass</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">addclass</span><span class="p">,</span> <span class="n">addmod</span><span class="p">)</span>
                    <span class="n">addinst</span> <span class="o">=</span> <span class="n">addclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addmod</span><span class="p">,</span> <span class="n">addinst</span><span class="p">)</span>
                    <span class="n">loaded</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1">### the addon is now available as self.addmod</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">traceback</span>
                    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> addon is not available: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">addmod</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
                    <span class="n">loaded</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">### error raised during addon/__init__.py import</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">addon</span><span class="o">.</span><span class="n">_errortrace</span><span class="p">[</span><span class="n">addmod</span><span class="p">])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> addon is not imported: check addon module&quot;</span> <span class="o">%</span> <span class="n">addmod</span><span class="p">)</span>
                <span class="n">loaded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1">### addon in unknown or disabled in addon.__all__</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> addon is unknown/disabled: check addon.__all__ in addon module&quot;</span> <span class="o">%</span> <span class="n">addmod</span><span class="p">)</span>
            <span class="n">loaded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">loaded</span><span class="p">:</span>
            <span class="c1">### addmod added to loaded_addons (to prevent further adding)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> addon is now available as attribute of mol instance&quot;</span> <span class="o">%</span> <span class="n">addmod</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loaded_addons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">addmod</span><span class="p">)</span>
        <span class="c1">#assert addmod in self.loaded_addons, &quot;%s not available&quot; % addmod ### KEEP for testing</span>
        <span class="k">return</span> <span class="n">loaded</span></div>

    <span class="c1">##### connectivity ########################################################################################</span>

<div class="viewcode-block" id="mol.check_conn"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.check_conn">[docs]</a>    <span class="k">def</span> <span class="nf">check_conn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        checks if connectivity is not broken</span>

<span class="sd">        Args:</span>
<span class="sd">            conn (list): list of lists holding the connectivity (default=None, check own )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> in conn[</span><span class="si">%d</span><span class="s2">] == </span><span class="si">%s</span><span class="s2">? </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">conn</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">conn</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">conn</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="mol.detect_conn"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.detect_conn">[docs]</a>    <span class="k">def</span> <span class="nf">detect_conn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span><span class="n">remove_duplicates</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fixed_dist</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        detects the connectivity of the system, based on covalent radii.</span>

<span class="sd">        Args:</span>
<span class="sd">            thresh (float): additive threshhold</span>
<span class="sd">            remove_duplicates (bool): flag for the detection of duplicates</span>
<span class="sd">            fixed_dist (bool or float, optional): Defaults to False. If a float is set this distance</span>
<span class="sd">                replaces covalent radii (for blueprints use 1.0)</span>

<span class="sd">        Todo:</span>
<span class="sd">            refactoring</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;detecting connectivity by distances ... &quot;</span><span class="p">)</span>

        <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span>
        <span class="n">elems</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elems</span>
        <span class="n">natoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">xyz</span> <span class="o">-</span> <span class="n">xyz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcond</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">cell_abc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellparams</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">a</span> <span class="o">-=</span> <span class="n">cell_abc</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">a</span><span class="o">/</span><span class="n">cell_abc</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcond</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">frac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_cell</span><span class="p">)</span>
                    <span class="n">frac</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">frac</span><span class="p">)</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">frac</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># distances from i to all other atoms</span>
            <span class="n">conn_local</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">remove_duplicates</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">natoms</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span> <span class="ow">and</span> <span class="n">dist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;atom </span><span class="si">%i</span><span class="s2"> is duplicate of atom </span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
                        <span class="n">duplicates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">fixed_dist</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span> <span class="ow">and</span> <span class="n">dist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">elements</span><span class="o">.</span><span class="n">get_covdistance</span><span class="p">([</span><span class="n">elems</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">elems</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span><span class="o">+</span><span class="n">thresh</span><span class="p">:</span>
                            <span class="n">conn_local</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i</span><span class="o">!=</span> <span class="n">j</span> <span class="ow">and</span> <span class="n">dist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">fixed_dist</span><span class="o">+</span><span class="n">thresh</span><span class="p">:</span>
                            <span class="n">conn_local</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remove_duplicates</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> <span class="n">conn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conn_local</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remove_duplicates</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicates</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Found and merged </span><span class="si">%d</span><span class="s2"> atom duplicates&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicates</span><span class="p">))</span>
                <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">duplicates</span><span class="p">))</span> <span class="c1"># multiple duplicates are taken once</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">duplicates</span><span class="p">)</span>
                <span class="c1"># compute</span>
                <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">duplicates</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># no need to make it list</span>
                <span class="n">elems</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">elems</span><span class="p">,</span> <span class="n">duplicates</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">atypes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atypes</span><span class="p">,</span><span class="n">duplicates</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">fragtypes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragtypes</span><span class="p">,</span><span class="n">duplicates</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">fragnumbers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span><span class="p">,</span><span class="n">duplicates</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="c1"># set</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_elems</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_atypes</span><span class="p">(</span><span class="n">atypes</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_fragtypes</span><span class="p">(</span><span class="n">fragtypes</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_fragnumbers</span><span class="p">(</span><span class="n">fragnumbers</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detect_conn</span><span class="p">(</span><span class="n">thresh</span> <span class="o">=</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">remove_duplicates</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_conn</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
            <span class="c1"># we had a pconn and redid the conn --&gt; need to reconstruct the pconn</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_pconn</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_ctab_from_conn</span><span class="p">(</span><span class="n">pconn_flag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_etab_from_tabs</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.set_conn_nopbc"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_conn_nopbc">[docs]</a>    <span class="k">def</span> <span class="nf">set_conn_nopbc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove periodic connectivity if it crosses cell boundaries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_frac_xyz</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn_nopbc</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">c</span> <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">frac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">frac</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="c1">#self.atoms_withconn_nopbc = [i for i,c in enumerate(self.conn_nopbc) if len(c) &gt; 0]</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.report_conn"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.report_conn">[docs]</a>    <span class="k">def</span> <span class="nf">report_conn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Print information on current connectivity, coordination number</span>
<span class="sd">            and the respective atomic distances &#39;&#39;&#39;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;reporting connectivity ... &quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="s2">&quot;atom </span><span class="si">%3d</span><span class="s2">   </span><span class="si">%2s</span><span class="s2"> coordination number: </span><span class="si">%3d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elems</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">conn</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conn</span><span class="p">)):</span>
                <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_neighb_dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="s2">&quot;   -&gt; </span><span class="si">%3d</span><span class="s2"> </span><span class="si">%2s</span><span class="s2"> : dist </span><span class="si">%10.5f</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">conn</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">elems</span><span class="p">[</span><span class="n">conn</span><span class="p">[</span><span class="n">j</span><span class="p">]],</span> <span class="n">d</span><span class="p">))</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.add_pconn"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.add_pconn">[docs]</a>    <span class="k">def</span> <span class="nf">add_pconn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">5000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate the periodic connectivity from the exisiting connectivity</span>
<span class="sd">        The pconn contains the image index of the bonded neighbor</span>
<span class="sd">        pconn is really needed only for small unit cells (usually topologies) where vertices</span>
<span class="sd">        can be bonded to itself (next image) or multiple times to the same vertex in different images.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># N.B. bullet-proof version of add_pconn!</span>
        <span class="c1"># It works also for nets, particulary the smaller ones [RA]</span>
        <span class="n">pimages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pconn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">):</span>
            <span class="n">uniquec</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="c1"># unique connected atoms</span>
            <span class="c1">#    [i,j,k,j,i,i] translates to [i,j,k]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uniquec</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                <span class="c1"># add periodic connectivity according to occurrence order</span>
                <span class="n">dc</span> <span class="o">=</span> <span class="p">{</span><span class="n">iuc</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">iuc</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="p">)}</span> <span class="c1"># dictionary of connectivity order:</span>
                <span class="c1">#    it defaults at -1 so that it gets 0 for the first occurrence,</span>
                <span class="c1">#    1 for the second, 2 for the third, etc.</span>
                <span class="c1">#    this auxiliary dictionary is intended to keep the number of</span>
                <span class="c1">#    occurrences along the running connectivity</span>
                <span class="n">oc</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span> <span class="c1"># occurence unique connectivity: the occurrence</span>
                <span class="c1">#    of that unique atom in the list:</span>
                <span class="c1">#    in the case of:   [i,j,k,j,i,i]</span>
                <span class="c1">#    it translates to: [0,0,0,1,1,2]</span>
                <span class="k">for</span> <span class="n">ji</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                    <span class="n">dc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">oc</span><span class="p">[</span><span class="n">ji</span><span class="p">]</span> <span class="o">=</span> <span class="n">dc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="c1"># N.B.: after this, the dictionary contains the order of the</span>
                <span class="c1">#    last occurence so that the number of occurences - 1 is stored:</span>
                <span class="c1">#    [i,j,k,j,i,i] -&gt; {i:2, j:1, k:0}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># proceed normally</span>
                <span class="n">dc</span> <span class="o">=</span> <span class="p">{</span><span class="n">iuc</span><span class="p">:</span><span class="mi">0</span> <span class="k">for</span> <span class="n">iuc</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="p">)}</span> <span class="c1"># dictionary connectivity ### first occurence at 0</span>
                <span class="n">oc</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span> <span class="c1"># occurence unique connectivity ### first for all!</span>
            <span class="n">uimgi</span> <span class="o">=</span> <span class="p">{</span><span class="n">j</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">c</span><span class="p">}</span> <span class="c1">### image indices for unique connecting atoms</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">uniquec</span><span class="p">:</span> <span class="c1">### unique connecting atoms</span>
                <span class="c1"># If an atom or vertex is connected to another one multiple times (in an image), this</span>
                <span class="c1"># will be visible in the self.conn attribute, where the same neighbour will be listed</span>
                <span class="c1"># multiple times.</span>
                <span class="c1"># Sometimes, the distances are a bit different from each other, and in this case, we</span>
                <span class="c1"># have to increase the threshold, until the get_distvec function will find all imgis.</span>
                <span class="n">n_conns</span> <span class="o">=</span> <span class="n">dc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="c1"># if summed by 1 you get the number of occurences per unique atom</span>
                <span class="n">t</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">;</span> <span class="n">niter</span> <span class="o">=</span><span class="mi">0</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="c1"># JK: sometimes it happens here that len(imgi) in the first iteration is &gt; n_conns</span>
                    <span class="c1"># and increasing thresh does not help. In this case something went wrong and we have to</span>
                    <span class="c1"># stop at some point (maxiter=5000) amounts to a thresh of 50 angstroms </span>
                    <span class="n">d</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">imgi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distvec</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">t</span> <span class="o">+=</span> <span class="mf">0.01</span>
                    <span class="k">if</span> <span class="n">n_conns</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgi</span><span class="p">):</span>
                        <span class="k">break</span>
                    <span class="n">niter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">niter</span> <span class="o">&gt;</span> <span class="n">maxiter</span><span class="p">:</span> 
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;add_pconn failed - infinite loop prevented&#39;</span><span class="p">)</span>
                <span class="n">uimgi</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgi</span>
            <span class="n">atoms_pconn</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">atoms_image</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ji</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">c</span><span class="p">):</span> <span class="c1">### unique connecting atoms</span>
                <span class="n">single_imgi</span> <span class="o">=</span> <span class="n">uimgi</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">oc</span><span class="p">[</span><span class="n">ji</span><span class="p">]]</span> <span class="c1">### take the ji-th occurrence wrt. that j index and get</span>
                <span class="c1">#    the unique ordered image for that partcular j-th atom</span>
                <span class="c1">#    [i,j,k,j,i,i] -&gt; [0,0,0,1,1,2] -&gt; [uimgi[0],uimgi[0],uimgi[0],uimgi[1],uimgi[1],uimgi[2]]</span>
                <span class="c1">#$</span>
                <span class="n">atoms_pconn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">single_imgi</span><span class="p">])</span>
                <span class="n">atoms_image</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_imgi</span><span class="p">)</span>
            <span class="n">pimages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atoms_image</span><span class="p">)</span>
            <span class="n">pconn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atoms_pconn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pimages</span> <span class="o">=</span> <span class="n">pimages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span> <span class="o">=</span> <span class="n">pconn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_etab_from_conns</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.add_pconn_old"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.add_pconn_old">[docs]</a>    <span class="k">def</span> <span class="nf">add_pconn_old</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DEPRECATED: here for reference in case of bug</span>
<span class="sd">        Generate the periodic connectivity from the exisiting connectivity</span>
<span class="sd">        The pconn contains the image index of the bonded neighbor</span>
<span class="sd">        pconn is really needed only for small unit cells (usually topologies) where vertices</span>
<span class="sd">        can be bonded to itself (next image) or multiple times to the same vertex in different images.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">### OLD ###</span>
        <span class="n">pimages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pconn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">):</span>
            <span class="n">atoms_pconn</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">atoms_image</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ji</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                <span class="c1"># If an atom or vertex is connected to another one multiple times (in an image), this</span>
                <span class="c1"># will be visible in the self.conn attribute, where the same neighbour will be listed</span>
                <span class="c1"># multiple times.</span>
                <span class="c1"># Sometimes, the distances are a bit different from each other, and in this case, we</span>
                <span class="c1"># have to increase the threshold, until the get_distvec function will find all imgis.</span>
                <span class="n">n_conns</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="n">t</span> <span class="o">=</span> <span class="mf">0.01</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">imgi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distvec</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">t</span> <span class="o">+=</span> <span class="mf">0.01</span>
                    <span class="k">if</span> <span class="n">n_conns</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgi</span><span class="p">):</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgi</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># only one neighbor .. all is fine</span>
                    <span class="n">atoms_pconn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">imgi</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="n">atoms_image</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imgi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># we need to assign an image to each connection</span>
                    <span class="c1"># if an atom is connected to another atom twice this means it must be another</span>
                    <span class="c1"># image</span>
                    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">imgi</span><span class="p">:</span>
                        <span class="c1"># test if this image is not used for this atom .. then we can use it</span>
                        <span class="k">if</span> <span class="n">atoms_image</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">atoms_image</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                            <span class="n">atoms_pconn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># ok, we have this image already</span>
                            <span class="n">use_it</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">iii</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atoms_image</span><span class="p">):</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">iii</span> <span class="o">==</span> <span class="n">ii</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">j</span><span class="p">):</span> <span class="n">use_it</span><span class="o">=</span><span class="kc">False</span>
                            <span class="k">if</span> <span class="n">use_it</span><span class="p">:</span>
                                <span class="n">atoms_image</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                                <span class="n">atoms_pconn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
            <span class="n">pimages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atoms_image</span><span class="p">)</span>
            <span class="n">pconn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atoms_pconn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pimages</span> <span class="o">=</span> <span class="n">pimages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span> <span class="o">=</span> <span class="n">pconn</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.check_need_pconn"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.check_need_pconn">[docs]</a>    <span class="k">def</span> <span class="nf">check_need_pconn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        check whether pconn is needed or not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pconn_needed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">):</span>
            <span class="c1"># if atom/vertex bonded to itself we need pconn</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span> <span class="n">pconn_needed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># check if a neigbor appears twice</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">pconn_needed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">pconn_needed</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">return</span> <span class="n">pconn_needed</span></div>

<div class="viewcode-block" id="mol.omit_pconn"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.omit_pconn">[docs]</a>    <span class="k">def</span> <span class="nf">omit_pconn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Omit the pconn (if there is one) if this is acceptable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_need_pconn</span><span class="p">():</span>
            <span class="c1"># ok we do not need ot and can discard it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.make_topo"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.make_topo">[docs]</a>    <span class="k">def</span> <span class="nf">make_topo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert this mol obejct to be a topo object.</span>
<span class="sd">        This means a pconn will be generated and written to file as well</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_topo</span><span class="p">:</span> <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_topo</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_need_pconn</span><span class="p">()</span> <span class="ow">and</span> <span class="n">check_flag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_pconn</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.unmake_topo"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.unmake_topo">[docs]</a>    <span class="k">def</span> <span class="nf">unmake_topo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a topo object back to a &quot;normal&quot; mol object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_topo</span><span class="p">:</span> <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_topo</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">omit_pconn</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.force_topo"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.force_topo">[docs]</a>    <span class="k">def</span> <span class="nf">force_topo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_topo</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_pconn</span><span class="p">()</span>
        <span class="k">return</span></div>

    <span class="c1">###  periodic systems .. cell manipulation ############</span>

<div class="viewcode-block" id="mol.make_supercell"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.make_supercell">[docs]</a>    <span class="k">def</span> <span class="nf">make_supercell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">supercell</span><span class="p">,</span> <span class="n">colorize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extend the periodic system in all directions by the factors given in the</span>
<span class="sd">            supercell upon preserving the connectivity of the initial system</span>
<span class="sd">        Can be used for systems with and without pconn</span>

<span class="sd">        :Args:</span>
<span class="sd">            supercell (iterable of ints): extends the cell three times in x and two times in y</span>
<span class="sd">                example: [2,2,2] or []</span>
<span class="sd">            colorize=False (bool): distinguish the duplicates by different colors</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">supercell</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">supercell</span><span class="p">)</span>
        <span class="n">ntot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell</span><span class="p">)</span>
        <span class="n">xyz</span> <span class="o">=</span>   <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntot</span><span class="p">)]</span>
        <span class="n">conn</span> <span class="o">=</span>  <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntot</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
            <span class="n">pconn</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pconn</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntot</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Generating </span><span class="si">%i</span><span class="s1"> x </span><span class="si">%i</span><span class="s1"> x </span><span class="si">%i</span><span class="s1"> supercell? No need to do that!&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">supercell</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">pconn</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">conn</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating </span><span class="si">%i</span><span class="s1"> x </span><span class="si">%i</span><span class="s1"> x </span><span class="si">%i</span><span class="s1"> supercell&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">supercell</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">images</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
        <span class="n">nat</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span>
        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">supercell</span>
        <span class="n">elems</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elems</span><span class="p">)</span>
        <span class="n">left</span><span class="p">,</span><span class="n">right</span><span class="p">,</span><span class="n">front</span><span class="p">,</span><span class="n">back</span><span class="p">,</span><span class="n">bot</span><span class="p">,</span><span class="n">top</span> <span class="o">=</span>  <span class="p">[],[],[],[],[],[]</span>
        <span class="n">neighs</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
        <span class="n">iii</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">iz</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
                    <span class="n">ixyz</span> <span class="o">=</span> <span class="n">ix</span><span class="o">+</span><span class="n">nx</span><span class="o">*</span><span class="n">iy</span><span class="o">+</span><span class="n">nx</span><span class="o">*</span><span class="n">ny</span><span class="o">*</span><span class="n">iz</span>
                    <span class="n">iii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="mi">0</span>   <span class="p">:</span> <span class="n">left</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">right</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">iy</span> <span class="o">==</span> <span class="mi">0</span>   <span class="p">:</span> <span class="n">bot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">iy</span> <span class="o">==</span> <span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">top</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">iz</span> <span class="o">==</span> <span class="mi">0</span>   <span class="p">:</span> <span class="n">front</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">iz</span> <span class="o">==</span> <span class="n">nz</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">back</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iz</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
                    <span class="n">ixyz</span> <span class="o">=</span> <span class="n">ix</span><span class="o">+</span><span class="n">nx</span><span class="o">*</span><span class="n">iy</span><span class="o">+</span><span class="n">nx</span><span class="o">*</span><span class="n">ny</span><span class="o">*</span><span class="n">iz</span>
                    <span class="c1"># BUG for layers: to be investigated</span>
                    <span class="n">dispvect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">iz</span><span class="p">])[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="c1">### THESE DO NOT WORK</span>
                    <span class="c1">#dispvect = np.sum(np.array([ix,iy,iz]*self.cell)[:,np.newaxis],axis=0)</span>
                    <span class="c1">#dispvect = np.sum(np.array([ix,iy,iz])[np.newaxis,:]*self.cell,axis=-1)</span>
                    <span class="c1">#dispvect = np.sum(np.array([ix,iy,iz])[np.newaxis,:]*self.cell,axis=0)</span>
                    <span class="n">xyz</span><span class="p">[</span><span class="n">ixyz</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dispvect</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">])):</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
                                <span class="n">allinbox</span> <span class="o">=</span> <span class="p">(</span><span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">pc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distvec</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">])[</span><span class="mi">2</span><span class="p">]</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_distvec</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">]))</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">])</span>
                                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;an Atom is connected to the same atom twice in different cells! </span><span class="se">\n</span><span class="s2"> Use pconn!&quot;</span><span class="p">)</span>
                                <span class="n">pc</span> <span class="o">=</span> <span class="n">pc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">allinbox</span> <span class="o">=</span> <span class="n">pc</span> <span class="o">==</span> <span class="mi">13</span>
                            <span class="k">if</span> <span class="n">allinbox</span><span class="p">:</span>
                                <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">ixyz</span><span class="o">*</span><span class="n">nat</span> <span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
                                    <span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
                                    <span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">,</span><span class="n">pz</span> <span class="o">=</span> <span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">,</span><span class="n">pz</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">pc</span><span class="p">]</span>
                                <span class="n">iix</span><span class="p">,</span><span class="n">iiy</span><span class="p">,</span><span class="n">iiz</span>  <span class="o">=</span> <span class="p">(</span><span class="n">ix</span><span class="o">+</span><span class="n">px</span><span class="p">)</span><span class="o">%</span><span class="n">nx</span><span class="p">,</span> <span class="p">(</span><span class="n">iy</span><span class="o">+</span><span class="n">py</span><span class="p">)</span><span class="o">%</span><span class="n">ny</span><span class="p">,</span> <span class="p">(</span><span class="n">iz</span><span class="o">+</span><span class="n">pz</span><span class="p">)</span><span class="o">%</span><span class="n">nz</span>
                                <span class="n">iixyz</span><span class="o">=</span> <span class="n">iix</span><span class="o">+</span><span class="n">nx</span><span class="o">*</span><span class="n">iiy</span><span class="o">+</span><span class="n">nx</span><span class="o">*</span><span class="n">ny</span><span class="o">*</span><span class="n">iiz</span>
                                <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">iixyz</span><span class="o">*</span><span class="n">nat</span> <span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
                                    <span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                                    <span class="k">if</span> <span class="p">((</span><span class="n">px</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>  <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span> <span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                                    <span class="k">if</span> <span class="p">((</span><span class="n">px</span> <span class="o">==</span>  <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">right</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span> <span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">1</span>
                                    <span class="k">if</span> <span class="p">((</span><span class="n">py</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">bot</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>   <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span> <span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                                    <span class="k">if</span> <span class="p">((</span><span class="n">py</span> <span class="o">==</span>  <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">top</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>   <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span> <span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">1</span>
                                    <span class="k">if</span> <span class="p">((</span><span class="n">pz</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">front</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span> <span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                                    <span class="k">if</span> <span class="p">((</span><span class="n">pz</span> <span class="o">==</span>  <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">back</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>  <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span> <span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pimages</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="p">[],[],[],[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pconn</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pp</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pimages</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">arr2idx</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">p</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span> <span class="o">=</span> <span class="n">nat</span><span class="o">*</span><span class="n">ntot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nat</span><span class="o">*</span><span class="n">ntot</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inv_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">colorize</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elems</span> <span class="o">+=</span> <span class="p">[</span><span class="n">vcolor2elem</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">vcolor2elem</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nat</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elems</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elems</span><span class="p">)</span><span class="o">*</span><span class="n">ntot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atypes</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atypes</span><span class="p">)</span><span class="o">*</span><span class="n">ntot</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragtypes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fragtypes</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragtypes</span><span class="p">)</span><span class="o">*</span><span class="n">ntot</span>
            <span class="n">mfn</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">fragnumbers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntot</span><span class="p">):</span>
                <span class="n">fragnumbers</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span><span class="p">)</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">mfn</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span> <span class="o">=</span> <span class="n">fragnumbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images_cellvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_ctab_from_conn</span><span class="p">(</span><span class="n">pconn_flag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_etab_from_tabs</span><span class="p">(</span><span class="n">sort_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">pconn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">conn</span></div>

<div class="viewcode-block" id="mol.make_supercell_old"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.make_supercell_old">[docs]</a>    <span class="k">def</span> <span class="nf">make_supercell_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">supercell</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DEPRECATED: IT WILL BE REMOVED IN A FEW COMMITS</span>
<span class="sd">        PLEASE ADD/FIX FEATURES/BUGS TO make_supercell</span>
<span class="sd">        here just in case of emergency</span>

<span class="sd">        Extends the periodic system in all directions by the factors given in the</span>
<span class="sd">            supercell upon preserving the connectivity of the initial system</span>
<span class="sd">            Can be used for systems with and without pconn</span>
<span class="sd">            Args:</span>
<span class="sd">                supercell: List of integers, e.g. [3,2,1] extends the cell three times in x and two times in y</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># HACK</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
            <span class="n">xyz</span><span class="p">,</span><span class="n">conn</span><span class="p">,</span><span class="n">pconn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_supercell_pconn</span><span class="p">(</span><span class="n">supercell</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">xyz</span><span class="p">,</span><span class="n">conn</span><span class="p">,</span><span class="n">pconn</span>
        <span class="c1"># END HACK</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">supercell</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">supercell</span><span class="p">)</span>
        <span class="n">ntot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell</span><span class="p">)</span>
        <span class="n">conn</span> <span class="o">=</span>  <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntot</span><span class="p">)]</span>
        <span class="n">xyz</span> <span class="o">=</span>   <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntot</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Generating </span><span class="si">%i</span><span class="s1"> x </span><span class="si">%i</span><span class="s1"> x </span><span class="si">%i</span><span class="s1"> supercell? No need to do that!&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">supercell</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">xyz</span><span class="p">,</span><span class="n">conn</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating </span><span class="si">%i</span><span class="s1"> x </span><span class="si">%i</span><span class="s1"> x </span><span class="si">%i</span><span class="s1"> supercell&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">supercell</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">images</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
        <span class="n">nat</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span>
        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">supercell</span>
        <span class="c1">#pconn = [copy.deepcopy(self.pconn) for i in range(ntot)]</span>
        <span class="n">elems</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elems</span><span class="p">)</span>
        <span class="n">left</span><span class="p">,</span><span class="n">right</span><span class="p">,</span><span class="n">front</span><span class="p">,</span><span class="n">back</span><span class="p">,</span><span class="n">bot</span><span class="p">,</span><span class="n">top</span> <span class="o">=</span>  <span class="p">[],[],[],[],[],[]</span>
        <span class="n">neighs</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
        <span class="n">iii</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">iz</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
                    <span class="n">ixyz</span> <span class="o">=</span> <span class="n">ix</span><span class="o">+</span><span class="n">nx</span><span class="o">*</span><span class="n">iy</span><span class="o">+</span><span class="n">nx</span><span class="o">*</span><span class="n">ny</span><span class="o">*</span><span class="n">iz</span>
                    <span class="n">iii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="mi">0</span>   <span class="p">:</span> <span class="n">left</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">right</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">iy</span> <span class="o">==</span> <span class="mi">0</span>   <span class="p">:</span> <span class="n">bot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">iy</span> <span class="o">==</span> <span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">top</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">iz</span> <span class="o">==</span> <span class="mi">0</span>   <span class="p">:</span> <span class="n">front</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">iz</span> <span class="o">==</span> <span class="n">nz</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">back</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iz</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
                    <span class="n">ixyz</span> <span class="o">=</span> <span class="n">ix</span><span class="o">+</span><span class="n">nx</span><span class="o">*</span><span class="n">iy</span><span class="o">+</span><span class="n">nx</span><span class="o">*</span><span class="n">ny</span><span class="o">*</span><span class="n">iz</span>
                    <span class="n">dispvect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">iz</span><span class="p">])[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">xyz</span><span class="p">[</span><span class="n">ixyz</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dispvect</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">])):</span>
                            <span class="n">pc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distvec</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">])[</span><span class="mi">2</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_distvec</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">]))</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">])</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;an Atom is connected to the same atom twice in different cells! </span><span class="se">\n</span><span class="s1"> requires pconn!! use topo molsys instead!&#39;</span><span class="p">)</span>
                            <span class="n">pc</span> <span class="o">=</span> <span class="n">pc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">pc</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
                                <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">ixyz</span><span class="o">*</span><span class="n">nat</span> <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">,</span><span class="n">pz</span>     <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">pc</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">img</span><span class="p">[</span><span class="n">pc</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">img</span><span class="p">[</span><span class="n">pc</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                                <span class="n">iix</span><span class="p">,</span><span class="n">iiy</span><span class="p">,</span><span class="n">iiz</span>  <span class="o">=</span> <span class="p">(</span><span class="n">ix</span><span class="o">+</span><span class="n">px</span><span class="p">)</span><span class="o">%</span><span class="n">nx</span><span class="p">,</span> <span class="p">(</span><span class="n">iy</span><span class="o">+</span><span class="n">py</span><span class="p">)</span><span class="o">%</span><span class="n">ny</span><span class="p">,</span> <span class="p">(</span><span class="n">iz</span><span class="o">+</span><span class="n">pz</span><span class="p">)</span><span class="o">%</span><span class="n">nz</span>
                                <span class="n">iixyz</span><span class="o">=</span> <span class="n">iix</span><span class="o">+</span><span class="n">nx</span><span class="o">*</span><span class="n">iiy</span><span class="o">+</span><span class="n">nx</span><span class="o">*</span><span class="n">ny</span><span class="o">*</span><span class="n">iiz</span>
                                <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">iixyz</span><span class="o">*</span><span class="n">nat</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="p">[],[]</span>
        <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_ctab_from_conn</span><span class="p">(</span><span class="n">pconn_flag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span> <span class="o">=</span> <span class="n">nat</span><span class="o">*</span><span class="n">ntot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nat</span><span class="o">*</span><span class="n">ntot</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inv_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elems</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elems</span><span class="p">)</span><span class="o">*</span><span class="n">ntot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atypes</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atypes</span><span class="p">)</span><span class="o">*</span><span class="n">ntot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fragtypes</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragtypes</span><span class="p">)</span><span class="o">*</span><span class="n">ntot</span>
        <span class="n">mfn</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">nfragnumbers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntot</span><span class="p">):</span>
            <span class="n">nfragnumbers</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span><span class="p">)</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">mfn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span><span class="o">=</span><span class="n">nfragnumbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images_cellvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xyz</span><span class="p">,</span><span class="n">conn</span></div>

    <span class="k">def</span> <span class="nf">_make_supercell_pconn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">supercell</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DEPRECATED: IT WILL BE REMOVED IN A FEW COMMITS</span>
<span class="sd">        PLEASE ADD/FIX FEATURES/BUGS TO make_supercell</span>
<span class="sd">        here just in case of emergency</span>

<span class="sd">        old make_supercell from topo object</span>
<span class="sd">        called automatically when pconn exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">supercell</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">supercell</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating </span><span class="si">%i</span><span class="s1"> x </span><span class="si">%i</span><span class="s1"> x </span><span class="si">%i</span><span class="s1"> supercell&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">supercell</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">images</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
        <span class="n">ntot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">supercell</span><span class="p">)</span>
        <span class="n">nat</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span>
        <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">supercell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">pconn</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pconn</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntot</span><span class="p">)]</span>
        <span class="n">conn</span> <span class="o">=</span>  <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntot</span><span class="p">)]</span>
        <span class="n">xyz</span> <span class="o">=</span>   <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntot</span><span class="p">)]</span>
        <span class="n">elems</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elems</span><span class="p">)</span>
        <span class="n">left</span><span class="p">,</span><span class="n">right</span><span class="p">,</span><span class="n">front</span><span class="p">,</span><span class="n">back</span><span class="p">,</span><span class="n">bot</span><span class="p">,</span><span class="n">top</span> <span class="o">=</span>  <span class="p">[],[],[],[],[],[]</span>
        <span class="n">neighs</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
        <span class="n">iii</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">iz</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
                    <span class="n">ixyz</span> <span class="o">=</span> <span class="n">ix</span><span class="o">+</span><span class="n">nx</span><span class="o">*</span><span class="n">iy</span><span class="o">+</span><span class="n">nx</span><span class="o">*</span><span class="n">ny</span><span class="o">*</span><span class="n">iz</span>
                    <span class="n">iii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="mi">0</span>   <span class="p">:</span> <span class="n">left</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ix</span> <span class="o">==</span> <span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">right</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">iy</span> <span class="o">==</span> <span class="mi">0</span>   <span class="p">:</span> <span class="n">bot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">iy</span> <span class="o">==</span> <span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">top</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">iz</span> <span class="o">==</span> <span class="mi">0</span>   <span class="p">:</span> <span class="n">front</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">iz</span> <span class="o">==</span> <span class="n">nz</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">back</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iz</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
                    <span class="n">ixyz</span> <span class="o">=</span> <span class="n">ix</span><span class="o">+</span><span class="n">nx</span><span class="o">*</span><span class="n">iy</span><span class="o">+</span><span class="n">nx</span><span class="o">*</span><span class="n">ny</span><span class="o">*</span><span class="n">iz</span>
                    <span class="n">dispvect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">iz</span><span class="p">])[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">xyz</span><span class="p">[</span><span class="n">ixyz</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dispvect</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">])):</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">==</span> <span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                                <span class="c1">#conn[i][cc][c] += ixyz*nat</span>
                                <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">ixyz</span><span class="o">*</span><span class="n">nat</span> <span class="p">)</span>
                                <span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">,</span><span class="n">pz</span>     <span class="o">=</span> <span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                                <span class="c1">#print(px,py,pz)</span>
                                <span class="n">iix</span><span class="p">,</span><span class="n">iiy</span><span class="p">,</span><span class="n">iiz</span>  <span class="o">=</span> <span class="p">(</span><span class="n">ix</span><span class="o">+</span><span class="n">px</span><span class="p">)</span><span class="o">%</span><span class="n">nx</span><span class="p">,</span> <span class="p">(</span><span class="n">iy</span><span class="o">+</span><span class="n">py</span><span class="p">)</span><span class="o">%</span><span class="n">ny</span><span class="p">,</span> <span class="p">(</span><span class="n">iz</span><span class="o">+</span><span class="n">pz</span><span class="p">)</span><span class="o">%</span><span class="n">nz</span>
                                <span class="n">iixyz</span><span class="o">=</span> <span class="n">iix</span><span class="o">+</span><span class="n">nx</span><span class="o">*</span><span class="n">iiy</span><span class="o">+</span><span class="n">nx</span><span class="o">*</span><span class="n">ny</span><span class="o">*</span><span class="n">iiz</span>
                                <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">iixyz</span><span class="o">*</span><span class="n">nat</span> <span class="p">)</span>
                                <span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                                <span class="k">if</span> <span class="p">((</span><span class="n">px</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>  <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span> <span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                                <span class="k">if</span> <span class="p">((</span><span class="n">px</span> <span class="o">==</span>  <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">right</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span> <span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">1</span>
                                <span class="k">if</span> <span class="p">((</span><span class="n">py</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">bot</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>   <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span> <span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                                <span class="k">if</span> <span class="p">((</span><span class="n">py</span> <span class="o">==</span>  <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">top</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>   <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span> <span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">1</span>
                                <span class="k">if</span> <span class="p">((</span><span class="n">pz</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">front</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span> <span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                                <span class="k">if</span> <span class="p">((</span><span class="n">pz</span> <span class="o">==</span>  <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">back</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ixyz</span><span class="p">)</span>  <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span> <span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">cc</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">1</span>
                                <span class="c1">#print(px,py,pz)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span> <span class="o">=</span> <span class="n">nat</span><span class="o">*</span><span class="n">ntot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pimages</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="p">[],[],[],[]</span>
        <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pconn</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pimages</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">arr2idx</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">p</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_ctab_from_conn</span><span class="p">(</span><span class="n">pconn_flag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nat</span><span class="o">*</span><span class="n">ntot</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellparams</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inv_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elems</span> <span class="o">*=</span> <span class="n">ntot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atypes</span><span class="o">*=</span><span class="n">ntot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images_cellvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_ctab_from_conn</span><span class="p">(</span><span class="n">pconn_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_etab_from_tabs</span><span class="p">(</span><span class="n">sort_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xyz</span><span class="p">,</span><span class="n">conn</span><span class="p">,</span><span class="n">pconn</span>

<div class="viewcode-block" id="mol.apply_pbc"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.apply_pbc">[docs]</a>    <span class="k">def</span> <span class="nf">apply_pbc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fixidx</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        apply pbc to the atoms of the system or some external positions</span>
<span class="sd">        Note: If pconn is used it is ivalid after this operation and will be reconstructed.</span>

<span class="sd">        Args:</span>
<span class="sd">            xyz (numpy array) : external positions, if None then self.xyz is wrapped into the box</span>
<span class="sd">            fixidx (int) : for an external system the origin can be defined (all atoms in one image). default=0 which means atom0 is reference, if fixidx=-1 all atoms will be wrapped</span>

<span class="sd">        Returns:</span>
<span class="sd">            xyz, in case xyz is not None (wrapped coordinates are returned) otherwise None is returned</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">xyz</span>
        <span class="k">if</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># apply to structure itself (does not return anything)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcond</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cell_abc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellparams</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,:]</span> <span class="o">-=</span> <span class="n">cell_abc</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="o">/</span><span class="n">cell_abc</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcond</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_frac_xyz</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,:]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">frac</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
                <span class="c1">#self.xyz[:,:] -= np.dot(np.floor(frac),self.cell)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
                <span class="c1"># we need to reconstruct pconn in this case</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_pconn</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># apply to xyz</span>
            <span class="k">assert</span> <span class="n">xyz</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;number of dimensions must be 2&quot;</span>
            <span class="k">if</span> <span class="n">fixidx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[:,:]</span> <span class="o">-</span> <span class="n">xyz</span><span class="p">[</span><span class="n">fixidx</span><span class="p">,:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[:,:]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcond</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cell_abc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellparams</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">xyz</span><span class="p">[:,:]</span> <span class="o">-=</span> <span class="n">cell_abc</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">a</span><span class="o">/</span><span class="n">cell_abc</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcond</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">frac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_cell</span><span class="p">)</span>
                <span class="n">xyz</span><span class="p">[:,:]</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">frac</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
                <span class="c1">#xyz[:,:] -= np.dot(np.floor(frac),self.cell)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_pconn</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">xyz</span></div>

    <span class="c1"># legacy name just to keep compat</span>
<div class="viewcode-block" id="mol.wrap_in_box"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.wrap_in_box">[docs]</a>    <span class="k">def</span> <span class="nf">wrap_in_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        legacy method maps on apply_pbc</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_pbc</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.get_cell"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_cell">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get cell vectors</span>

<span class="sd">        Get the cell vectors as a 3x3 matrix, where the rows are the individual cell vectors</span>

<span class="sd">        Returns:</span>
<span class="sd">            numpy.ndarray: the cell matrix cell[0] or cell[0,:] is the first cell vector</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span></div>

<div class="viewcode-block" id="mol.get_cellparams"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_cellparams">[docs]</a>    <span class="k">def</span> <span class="nf">get_cellparams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; return unit cell information (a, b, c, alpha, beta, gamma) &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellparams</span></div>

<div class="viewcode-block" id="mol.get_volume"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_volume">[docs]</a>    <span class="k">def</span> <span class="nf">get_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;returns volume of the cell</span>

<span class="sd">        Computes the Volume and returns it in cubic Angstroms</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: Volume</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cell</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">cx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">cx</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span></div>

<div class="viewcode-block" id="mol.set_volume"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_volume">[docs]</a>    <span class="k">def</span> <span class="nf">set_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Volume</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;rescales the cell to  achieve a given volume</span>

<span class="sd">        Rescales the unit cell in order to achieve a target volume.</span>
<span class="sd">        Tested only for orthorombic systems!</span>

<span class="sd">        Parameters:</span>
<span class="sd">            Volume (float)      : Target volume in cubic Angstroms</span>
<span class="sd">        Returns:</span>
<span class="sd">            float: fact         : Scaling factor used to scale the cell parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Vx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volume</span><span class="p">()</span>
        <span class="n">fact</span> <span class="o">=</span> <span class="p">(</span><span class="n">Volume</span> <span class="o">/</span> <span class="n">Vx</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
        <span class="n">abc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cellparams</span><span class="p">()</span>
        <span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">abc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">abc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">abc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">fact</span><span class="p">,</span><span class="n">abc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">fact</span><span class="p">,</span><span class="n">abc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">fact</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cellparams</span><span class="p">(</span><span class="n">abc</span><span class="p">,</span><span class="n">cell_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">Vnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volume</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Vnew</span> <span class="o">-</span> <span class="n">Volume</span><span class="p">)</span>  <span class="o">&lt;=</span> <span class="mf">0.1</span>
        <span class="k">return</span> <span class="n">fact</span></div>

<div class="viewcode-block" id="mol.set_bcond"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_bcond">[docs]</a>    <span class="k">def</span> <span class="nf">set_bcond</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets the boundary conditions. 2 for cubic and orthorombic systems,</span>
<span class="sd">        3 for triclinic systems</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cellparams</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span> <span class="o">==</span> <span class="p">[</span><span class="mf">90.0</span><span class="p">,</span><span class="mf">90.0</span><span class="p">,</span><span class="mf">90.0</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcond</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellparams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellparams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellparams</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bcond</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bcond</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.make_nonperiodic"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.make_nonperiodic">[docs]</a>    <span class="k">def</span> <span class="nf">make_nonperiodic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;makes the system non-periodic (forget all perdiodicity infomation)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcond</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell</span>  <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="mol.get_bcond"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_bcond">[docs]</a>    <span class="k">def</span> <span class="nf">get_bcond</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the boundary conditions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bcond</span></div>

<div class="viewcode-block" id="mol.set_cell"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_cell">[docs]</a>    <span class="k">def</span> <span class="nf">set_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span><span class="n">cell_only</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; set unit cell using cell vectors and assign cellparams</span>
<span class="sd">        Parameters:</span>
<span class="sd">            cell: cell vectors (3,3)</span>
<span class="sd">            cell_only (bool)  : if False, also the coordinates are changed</span>
<span class="sd">                                  in respect to new cell</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cell_only</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">frac_xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_frac_from_xyz</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellparams</span> <span class="o">=</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">abc_from_vectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inv_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images_cellvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_bcond</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cell_only</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_xyz_from_frac</span><span class="p">(</span><span class="n">frac_xyz</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.set_cellparams"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_cellparams">[docs]</a>    <span class="k">def</span> <span class="nf">set_cellparams</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cellparams</span><span class="p">,</span> <span class="n">cell_only</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; set unit cell using cell parameters and assign cell vectors</span>
<span class="sd">        Parameters:</span>
<span class="sd">            cellparams: vector (6)</span>
<span class="sd">            cell_only (bool)  : if false, also the coordinates are changed</span>
<span class="sd">                                  in respect to new cell</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">cellparams</span><span class="p">))</span> <span class="o">==</span> <span class="mi">6</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">vectors_from_abc</span><span class="p">(</span><span class="n">cellparams</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">cell_only</span><span class="o">=</span><span class="n">cell_only</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.set_empty_cell"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_empty_cell">[docs]</a>    <span class="k">def</span> <span class="nf">set_empty_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; set empty cell and related attributes&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bcond</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellparams</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images_cellvec</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="mol.get_wrapping_cell"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_wrapping_cell">[docs]</a>    <span class="k">def</span> <span class="nf">get_wrapping_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;set wrapping cell for non-periodic molecule&#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;no cell around a non-periodic molecule!&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">lenghts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">lenghts</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">+</span><span class="n">alpha</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="p">[</span><span class="mf">90.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">]</span>
        <span class="n">cellparams</span> <span class="o">=</span> <span class="n">lenghts</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="n">angles</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">unit_cell</span><span class="o">.</span><span class="n">vectors_from_abc</span><span class="p">(</span><span class="n">cellparams</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cell</span></div>

<div class="viewcode-block" id="mol.set_wrapping_cell"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_wrapping_cell">[docs]</a>    <span class="k">def</span> <span class="nf">set_wrapping_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;set wrapping cell for non-periodic molecule&#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;no cell around a non-periodic molecule!&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_wrapping_cell</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">))</span>
        <span class="k">return</span></div>

    <span class="c1">### rewrite on set_cell ???</span>
<div class="viewcode-block" id="mol.scale_cell"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.scale_cell">[docs]</a>    <span class="k">def</span> <span class="nf">scale_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">cell_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; scales the cell by a given factor</span>

<span class="sd">        Parameters:</span>
<span class="sd">            scale: either single float or an array of len 3&#39;&#39;&#39;</span>

        <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cell</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cell</span> <span class="o">*=</span> <span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">cell_only</span><span class="o">=</span><span class="n">cell_only</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.get_frac_xyz"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_frac_xyz">[docs]</a>    <span class="k">def</span> <span class="nf">get_frac_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xyz</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_frac_from_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">)</span></div>

<div class="viewcode-block" id="mol.get_frac_from_xyz"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_frac_from_xyz">[docs]</a>    <span class="k">def</span> <span class="nf">get_frac_from_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Returns the fractional atomic coordinates</span>

<span class="sd">        Parameters:</span>
<span class="sd">            xyz=None (array): optional external coordinates</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span>
        <span class="n">cell_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">cell_inv</span><span class="p">)</span></div>

<div class="viewcode-block" id="mol.get_xyz_from_frac"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_xyz_from_frac">[docs]</a>    <span class="k">def</span> <span class="nf">get_xyz_from_frac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">frac_xyz</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; returns real coordinates from an array of fractional coordinates using the current cell info</span>

<span class="sd">        Args:</span>
<span class="sd">            frac_xyz (array): fractional coords to be converted to xyz</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frac_xyz</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span></div>

<div class="viewcode-block" id="mol.set_xyz_from_frac"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_xyz_from_frac">[docs]</a>    <span class="k">def</span> <span class="nf">set_xyz_from_frac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frac_xyz</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Sets atomic coordinates based on input fractional coordinates</span>

<span class="sd">        Arg</span>
<span class="sd">            - frac_xyz (array): fractional coords to be converted to xyz</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">assert</span> <span class="n">frac_xyz</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">frac_xyz</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.get_image"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_image">[docs]</a>    <span class="k">def</span> <span class="nf">get_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xyz</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; returns the xyz coordinates of a set of coordinates in a specific cell</span>
<span class="sd">        Parameters:</span>
<span class="sd">            xyz   : xyz coordinates for which the image coordinates are to be retrieved</span>
<span class="sd">            img   : descriptor of the image, either an &quot;images&quot; integer (see molsys.util.images)</span>
<span class="sd">                      or the unit direction vector, e.g. [1,-1,0]&#39;&#39;&#39;</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">dispvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">img</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">dispvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">img</span><span class="p">])[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xyz</span> <span class="o">+</span> <span class="n">dispvec</span></div>


    <span class="c1">###  add mol objects and copy ##########################################</span>

<div class="viewcode-block" id="mol.add_mol"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.add_mol">[docs]</a>    <span class="k">def</span> <span class="nf">add_mol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">translate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rotate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">roteuler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rotmat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; adds a  nonperiodic mol object to the current one ... self can be both</span>
<span class="sd">            Parameters:</span>
<span class="sd">                other        (mol)      : an instance of the to-be-inserted mol instance</span>
<span class="sd">                translate (numpy.ndarry): numpy array as shift vector for the other mol</span>
<span class="sd">                rotate (numpy.ndarry)   : rotation triple to apply to the other mol object before insertion</span>
<span class="sd">                scale (float)           : scaling factor for other mol object coodinates</span>
<span class="sd">                roteuler (numpy.ndarry) : euler angles to apply a rotation prior to insertion&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Add mols with pconn, which may need tinkering&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">==</span><span class="n">other</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;can not add periodic systems with unequal cells!!&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="n">other_xyz</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">xyz</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># NOTE: it is important ot keep the order of operations</span>
        <span class="c1">#       1 ) scale</span>
        <span class="c1">#       2 ) rotate by euler angles</span>
        <span class="c1">#       2a) rotate by rotmat</span>
        <span class="c1">#       3 ) rotate by orientation triple</span>
        <span class="c1">#       4 ) translate</span>
        <span class="k">if</span> <span class="n">scale</span>    <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">other_xyz</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">roteuler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">other_xyz</span> <span class="o">=</span> <span class="n">rotations</span><span class="o">.</span><span class="n">rotate_by_euler</span><span class="p">(</span><span class="n">other_xyz</span><span class="p">,</span> <span class="n">roteuler</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rotate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">other_xyz</span> <span class="o">=</span> <span class="n">rotations</span><span class="o">.</span><span class="n">rotate_by_triple</span><span class="p">(</span><span class="n">other_xyz</span><span class="p">,</span> <span class="n">rotate</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rotmat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">other_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotmat</span><span class="p">,</span><span class="n">other_xyz</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="n">translate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">other_xyz</span> <span class="o">+=</span> <span class="n">translate</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">other_xyz</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">other_xyz</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elems</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">elems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atypes</span><span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">atypes</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">conn</span><span class="p">:</span>
            <span class="n">cn</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">natoms</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">fragtypes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">other</span><span class="o">.</span><span class="n">set_nofrags</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_fragtypes</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">fragtypes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_fragnumbers</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">fragnumbers</span><span class="p">)</span>
        <span class="c1">#self.fragtypes += other.fragtypes</span>
        <span class="c1">#start_fragnumber = sorted(self.fragnumbers)[-1]+1</span>
        <span class="c1">#self.fragnumbers += list(np.array(other.fragnumbers)+start_fragnumber)</span>
        <span class="c1"># update molid if present</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">molid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># add the other molecules molid</span>
            <span class="n">nmols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molid</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">molid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_molid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molid</span><span class="p">)</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">molid</span><span class="o">+</span><span class="n">nmols</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># in this case the added molecule had no molid -&gt; MUST be only one molecule</span>
                <span class="n">new_molid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molid</span><span class="p">)</span><span class="o">+</span><span class="n">other</span><span class="o">.</span><span class="n">get_natoms</span><span class="p">()</span><span class="o">*</span><span class="p">[</span><span class="n">nmols</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">molid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_molid</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.new_mol_by_index"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.new_mol_by_index">[docs]</a>    <span class="k">def</span> <span class="nf">new_mol_by_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new mol object which consists of the atoms specified in thfe argument.</span>

<span class="sd">        Args:</span>
<span class="sd">            idx (list) : list of indices to be extracted as a new mol object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">### NEW ### pconn-aware method</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;extracting </span><span class="si">%s</span><span class="s2"> out of </span><span class="si">%s</span><span class="s2"> atoms&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">))</span>
        <span class="n">sorted_idx</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sorted_idx</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;provided selected atoms&#39; indices are unsorted: keep it in mind&quot;</span>
            <span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">mol</span><span class="p">()</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">bads</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
        <span class="n">m</span><span class="o">.</span><span class="n">delete_atoms</span><span class="p">(</span><span class="n">bads</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span></div>
        <span class="c1">### DEPRECATED ### NOT pconn-aware method</span>
        <span class="c1">#assert not self.use_pconn, &quot;This method can not be used with pconn!&quot;</span>
        <span class="c1">#m.set_natoms(len(idx))</span>
        <span class="c1">#d = {}</span>
        <span class="c1">#elems = []</span>
        <span class="c1">#xyz = []</span>
        <span class="c1">#atypes = []</span>
        <span class="c1">#for n,i in enumerate(idx):</span>
        <span class="c1">#    d[i] = n</span>
        <span class="c1">#    elems.append(self.elems[i])</span>
        <span class="c1">#    xyz.append(self.xyz[i,:])</span>
        <span class="c1">#    atypes.append(self.atypes[i])</span>
        <span class="c1">#m.set_elems(elems)</span>
        <span class="c1">#m.set_xyz(np.array(xyz))</span>
        <span class="c1">#m.set_atypes(atypes)</span>
        <span class="c1">#conn = []</span>
        <span class="c1">#import pdb; pdb.set_trace()</span>
        <span class="c1">#for i in idx:</span>
        <span class="c1">#    this_conn = []</span>
        <span class="c1">#    for j in self.conn[i]:</span>
        <span class="c1">#        try:</span>
        <span class="c1">#            this_conn.append(d[j])</span>
        <span class="c1">#        except KeyError:</span>
        <span class="c1">#            pass</span>
        <span class="c1">#    conn.append(this_conn)</span>
        <span class="c1">#m.set_conn(conn)</span>
        <span class="c1">## handle periodic boundary conditions</span>
        <span class="c1">#if type(self.cell) != type(None):</span>
        <span class="c1">#    m.set_cell(self.cell)</span>
        <span class="c1">#    m.periodic = True</span>
        <span class="c1">#    &quot;&quot;&quot; ###SOURCE OF BUG, YET NOT STUDIED</span>
        <span class="c1">#    stop = False</span>
        <span class="c1">#    while not stop:</span>
        <span class="c1">#        stop = True</span>
        <span class="c1">#        for i, conns in enumerate(m.conn):</span>
        <span class="c1">#            for j in conns:</span>
        <span class="c1">#                d, r, imgi = m.get_distvec(i, j)</span>
        <span class="c1">#                if imgi != [13]:</span>
        <span class="c1">#                    stop = False</span>
        <span class="c1">#                    for ik, k in enumerate(self.cell):</span>
        <span class="c1">#                        m.xyz[j] += k * images[imgi][0][ik]</span>
        <span class="c1">#                    break</span>
        <span class="c1">#    &quot;&quot;&quot;</span>
        <span class="c1">#    ### it SEEMS to work now without the while loop, NO WARRANTY (RA+MD)</span>
        <span class="c1">#    for i, conns in enumerate(m.conn):</span>
        <span class="c1">#        for j in conns:</span>
        <span class="c1">#            d, r, imgi = m.get_distvec(i, j)</span>
        <span class="c1">#            if imgi != [13]:</span>
        <span class="c1">#                for ik, k in enumerate(self.cell):</span>
        <span class="c1">#                    m.xyz[j] += k * images[imgi][0][ik]</span>
        <span class="c1">#                break</span>
        <span class="c1">#    m.cell = None</span>
        <span class="c1">#    m.cellparams = None</span>
        <span class="c1">#    m.periodic = False</span>
        <span class="c1">#return m</span>

    <span class="c1">##### add and delete atoms and bonds ###########################################################</span>

<div class="viewcode-block" id="mol.add_bond"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.add_bond">[docs]</a>    <span class="k">def</span> <span class="nf">add_bond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">idx1</span><span class="p">,</span><span class="n">idx2</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; function necessary for legacy reasons! &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_bonds</span><span class="p">(</span><span class="n">idx1</span><span class="p">,</span><span class="n">idx2</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.add_bonds"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.add_bonds">[docs]</a>    <span class="k">def</span> <span class="nf">add_bonds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lista1</span><span class="p">,</span> <span class="n">lista2</span><span class="p">,</span> <span class="n">many2many</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        add bonds/edges/connections to a mol object between exisiting atoms/vertices</span>

<span class="sd">        If lists have got just one atom per each, sets 1 bond (gracefully collapses to add_bond)</span>
<span class="sd">        between atom of list 1 and atom of list 2.</span>
<span class="sd">        For many2many == False the length of lista1 and lista2 must be equal</span>


<span class="sd">        For many2many = True a Many-to-many connectivity is used:</span>
<span class="sd">        Sets NxM  bonds, where N and M is the number of atoms per each list.</span>
<span class="sd">        Each atom of list 1 is connected to each atom of list 2.</span>
<span class="sd">        This is rarely wanted unless (at least) one of the lists has got only one atom.</span>
<span class="sd">        In that case, sets Nx1=N bonds, where N is the number of atoms of the &quot;long&quot; list.</span>
<span class="sd">        Each atom of the &quot;long&quot; list is connected to the atom of the &quot;short&quot; one.</span>

<span class="sd">        Args:</span>
<span class="sd">            lista1(iterable of int): iterable 1 of atom indices</span>
<span class="sd">            lista2(iterable of int): iterable 2 of atom indices</span>
<span class="sd">            many2many (boolean):     switch to many2many mode</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lista1</span><span class="p">,</span><span class="s1">&#39;__iter__&#39;</span><span class="p">):</span> <span class="n">lista1</span> <span class="o">=</span> <span class="p">[</span><span class="n">lista1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">lista2</span><span class="p">,</span><span class="s1">&#39;__iter__&#39;</span><span class="p">):</span> <span class="n">lista2</span> <span class="o">=</span> <span class="p">[</span><span class="n">lista2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">many2many</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lista1</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">lista2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">many2many</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a1</span> <span class="ow">in</span> <span class="n">lista1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">a2</span> <span class="ow">in</span> <span class="n">lista2</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">a1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">a2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
                        <span class="n">d</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">imgi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distvec</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span><span class="p">[</span><span class="n">a1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">imgi</span><span class="p">])</span>
                        <span class="n">d</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">imgi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distvec</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span><span class="n">a1</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span><span class="p">[</span><span class="n">a2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">imgi</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a1</span><span class="p">,</span><span class="n">a2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lista1</span><span class="p">,</span> <span class="n">lista2</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">a1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">a2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
                        <span class="n">d</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">imgi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distvec</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span><span class="p">[</span><span class="n">a1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">imgi</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                        <span class="n">d</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">imgi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distvec</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span><span class="n">a1</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span><span class="p">[</span><span class="n">a2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">imgi</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.add_shortest_bonds"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.add_shortest_bonds">[docs]</a>    <span class="k">def</span> <span class="nf">add_shortest_bonds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lista1</span><span class="p">,</span><span class="n">lista2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds bonds between atoms from list1 and list2 (same length!) to connect</span>
<span class="sd">        the shortest pairs</span>

<span class="sd">        in the 2x2 case, simple choice is used whereas for larger sets the hungarian method</span>
<span class="sd">        is used</span>

<span class="sd">        Args:</span>
<span class="sd">            lista1 (list) : list of atoms</span>
<span class="sd">            lista2 (list) : list of atoms</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lista1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">lista2</span><span class="p">),</span> <span class="s2">&quot;only for lists of same length: </span><span class="si">%d</span><span class="s2">x != </span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lista1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lista2</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lista1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">a11</span><span class="p">,</span> <span class="n">a12</span> <span class="o">=</span> <span class="n">lista1</span>
            <span class="n">a21</span><span class="p">,</span> <span class="n">a22</span> <span class="o">=</span> <span class="n">lista2</span>
            <span class="n">d0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distvec</span><span class="p">(</span><span class="n">a11</span><span class="p">,</span><span class="n">a21</span><span class="p">)</span>
            <span class="n">d1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distvec</span><span class="p">(</span><span class="n">a11</span><span class="p">,</span><span class="n">a22</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d1</span> <span class="o">&gt;</span> <span class="n">d0</span><span class="p">:</span> <span class="c1">#straight</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_bonds</span><span class="p">(</span><span class="n">a11</span><span class="p">,</span><span class="n">a21</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_bonds</span><span class="p">(</span><span class="n">a12</span><span class="p">,</span><span class="n">a22</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#cross</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_bonds</span><span class="p">(</span><span class="n">a11</span><span class="p">,</span><span class="n">a22</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_bonds</span><span class="p">(</span><span class="n">a12</span><span class="p">,</span><span class="n">a21</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">linear_sum_assignment</span> <span class="k">as</span> <span class="n">hungarian</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lista1</span><span class="p">)</span>
            <span class="n">dmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">dim</span><span class="p">,</span><span class="n">dim</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">e1</span><span class="p">,</span><span class="n">a1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lista1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">e2</span><span class="p">,</span><span class="n">a2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lista2</span><span class="p">):</span>
                    <span class="n">dmat</span><span class="p">[</span><span class="n">e1</span><span class="p">,</span><span class="n">e2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distvec</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">a1which</span><span class="p">,</span> <span class="n">a2which</span> <span class="o">=</span> <span class="n">hungarian</span><span class="p">(</span><span class="n">dmat</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_bonds</span><span class="p">(</span><span class="n">lista1</span><span class="p">[</span><span class="n">a1which</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">lista2</span><span class="p">[</span><span class="n">a2which</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.delete_bond"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.delete_bond">[docs]</a>    <span class="k">def</span> <span class="nf">delete_bond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;delete bond between atom i and j</span>

<span class="sd">        Args:</span>
<span class="sd">            i (int): atom 1</span>
<span class="sd">            j (int): atom 2</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idxj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">idxi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idxj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idxi</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idxj</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idxi</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.add_atom"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.add_atom">[docs]</a>    <span class="k">def</span> <span class="nf">add_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elem</span><span class="p">,</span> <span class="n">atype</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">fragtype</span><span class="o">=</span><span class="s1">&#39;-1&#39;</span><span class="p">,</span> <span class="n">fragnumber</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        add a ato/vertex to the system (unconnected)</span>

<span class="sd">        Args:</span>
<span class="sd">            elem (string):    element symbol</span>
<span class="sd">            atype (string):   atom type string</span>
<span class="sd">            xyz (ndarry [3]): coordinates</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">atype</span><span class="p">)</span><span class="o">==</span> <span class="nb">str</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atype</span><span class="p">)</span>
        <span class="n">xyz</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">xyz</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">xyz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

        <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragtypes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)):</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">fragtypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fragtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fragnumber</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="o">-</span><span class="mi">1</span></div>

<div class="viewcode-block" id="mol.insert_atom"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.insert_atom">[docs]</a>    <span class="k">def</span> <span class="nf">insert_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">elem</span><span class="p">,</span> <span class="n">atype</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inserts an atom in a bond netween i and j</span>

<span class="sd">        Adds the atom at position between i and j or at xyz if given</span>

<span class="sd">        Args:</span>
<span class="sd">            elem (str): element</span>
<span class="sd">            atype (str): atomtype</span>
<span class="sd">            i (integer): atom 1</span>
<span class="sd">            j (integer): atom 2</span>
<span class="sd">            xyz (ndarray[3]): optional xyz position</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distvec</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
            <span class="n">new_xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_xyz</span> <span class="o">=</span> <span class="n">xyz</span>
        <span class="n">new_atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">atype</span><span class="p">,</span> <span class="n">new_xyz</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_bond</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_bonds</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],[</span><span class="n">new_atom</span><span class="p">,</span><span class="n">new_atom</span><span class="p">])</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.delete_atoms"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.delete_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">delete_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bads</span><span class="p">,</span> <span class="n">keep_conn</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        deletes an atom and its connections and fixes broken indices of all</span>
<span class="sd">            other atoms</span>
<span class="sd">        if keep_conn == True:</span>
<span class="sd">            connectivity is kept when atoms are in the middle of two others</span>
<span class="sd">        N.B. EXPERIMENTAL for use_pconn: you&#39;d like to recompute pconn</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bads</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span> <span class="c1"># only one atom is provided</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_atoms</span><span class="p">([</span><span class="n">bads</span><span class="p">],</span> <span class="n">keep_conn</span><span class="o">=</span><span class="n">keep_conn</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;deleting </span><span class="si">%s</span><span class="s2"> out of </span><span class="si">%s</span><span class="s2"> atoms&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bads</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">))</span>
        <span class="n">bads</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">goods</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bads</span><span class="p">]</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bads</span><span class="p">:</span>
                <span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">goods</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elems</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elems</span><span class="p">,</span> <span class="n">goods</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atypes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atypes</span><span class="p">,</span> <span class="n">goods</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amass</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">amass</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amass</span><span class="p">,</span> <span class="n">goods</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragtypes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fragtypes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragtypes</span><span class="p">,</span> <span class="n">goods</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span><span class="p">,</span> <span class="n">goods</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nfrags</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Counter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[:]</span>
            <span class="n">pconn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span><span class="p">[:]</span>
            <span class="n">pimages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pimages</span><span class="p">[:]</span>
            <span class="k">if</span> <span class="n">keep_conn</span><span class="p">:</span>
                <span class="c1">#works ONLY for edges: ERROR for terminal atoms and TRASH for the rest</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span> <span class="c1">#must go before setting self.conn</span>
                    <span class="n">pconn</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">[</span>
                            <span class="c1"># get image jp in i-th pconn if j-th atom of i-th conn not in bads</span>
                            <span class="n">jp</span> <span class="k">if</span> <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bads</span> <span class="k">else</span>
                            <span class="p">[</span>
                            <span class="c1"># else (j-th atom of i-th con in bads) get image kp</span>
                            <span class="c1"># in the pconn of j-th atom in ith conn</span>
                            <span class="c1">#    and get the first (TBI: all) among atoms associated to each kp different than i</span>
                                <span class="n">kp</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">kp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pconn</span><span class="p">[</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]])</span>
                                    <span class="k">if</span> <span class="n">conn</span><span class="p">[</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]][</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="n">i</span>
                            <span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#works only for edges</span>
                            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">jp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="p">]</span>
                        <span class="c1"># if i-th atom not in bads</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bads</span>
                    <span class="p">]</span>
                    <span class="n">pimages</span> <span class="o">=</span> <span class="p">[[</span><span class="n">arr2idx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">pi</span><span class="p">]</span> <span class="k">for</span> <span class="n">pi</span> <span class="ow">in</span> <span class="n">pconn</span><span class="p">]</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="c1"># subtract the j-th offset to atom j in i-th conn if j not in bads</span>
                        <span class="n">j</span><span class="o">-</span><span class="n">offset</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bads</span> <span class="k">else</span>
                        <span class="c1"># else (j in bads) subtract the k-th offset to atom k in j-th conn</span>
                        <span class="c1">#    and get the first (TBI: all) among atoms different than i</span>
                        <span class="p">[</span>
                            <span class="n">k</span><span class="o">-</span><span class="n">offset</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">conn</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">i</span>
                        <span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#works only for edges</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="p">]</span>
                    <span class="c1"># if atom i not in bads</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bads</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
                    <span class="c1"># pconn must go before setting conn</span>
                    <span class="n">pconn</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">[</span>
                            <span class="c1"># get image jp in i-th pconn if j-th atom of i-th conn not in bads</span>
                            <span class="n">jp</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">jp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bads</span>
                        <span class="p">]</span>
                        <span class="c1"># if atom i not in bads</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bads</span>
                    <span class="p">]</span>
                    <span class="n">pimages</span> <span class="o">=</span> <span class="p">[[</span><span class="n">arr2idx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">pi</span><span class="p">]</span> <span class="k">for</span> <span class="n">pi</span> <span class="ow">in</span> <span class="n">pconn</span><span class="p">]</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span>
                        <span class="c1"># subtract the j-th offset to atom j in i-th conn if j not in bads</span>
                        <span class="n">j</span><span class="o">-</span><span class="n">offset</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bads</span>
                    <span class="p">]</span>
                    <span class="c1"># if atom i not in bads</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bads</span>
                <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">goods</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span> <span class="o">=</span> <span class="n">pconn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pimages</span> <span class="o">=</span> <span class="n">pimages</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_etab_from_conns</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.delete_atom"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.delete_atom">[docs]</a>    <span class="k">def</span> <span class="nf">delete_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">bad</span><span class="p">,</span> <span class="n">keep_conn</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;deletes an atom and its connections and fixes broken indices of all other atoms</span>

<span class="sd">        Args:</span>
<span class="sd">            bad (integer): atom index to remove</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_atoms</span><span class="p">([</span><span class="n">bad</span><span class="p">],</span> <span class="n">keep_conn</span><span class="o">=</span><span class="n">keep_conn</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.remove_dummies"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.remove_dummies">[docs]</a>    <span class="k">def</span> <span class="nf">remove_dummies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;xx&#39;</span><span class="p">],</span> <span class="n">keep_conn</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; removes atoms by atom labels</span>
<span class="sd">        Args:</span>
<span class="sd">            labels (list): atom labels to be removed&#39;&#39;&#39;</span>
        <span class="n">badlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elems</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">badlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removing &#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">badlist</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_atoms</span><span class="p">(</span><span class="n">badlist</span><span class="p">,</span> <span class="n">keep_conn</span><span class="o">=</span><span class="n">keep_conn</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.remove_overlapping_atoms"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.remove_overlapping_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">remove_overlapping_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="n">SMALL_DIST</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        remove atoms/vertices which are closer than thresh</span>

<span class="sd">        Note that it is unpredictable which atom is removed from the overlapping pair.</span>

<span class="sd">        Args:</span>
<span class="sd">            thresh : distance threshold</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">badlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
                <span class="n">d</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">imgi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_distvec</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">:</span>
                    <span class="n">badlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_atoms</span><span class="p">(</span><span class="n">badlist</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.get_duplicates"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_duplicates">[docs]</a>    <span class="k">def</span> <span class="nf">get_duplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-03</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-03</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get duplicate atoms within given tolerances</span>
<span class="sd">        as separated method from remove_duplicates so it can accept custom xyz</span>
<span class="sd">        see also util.misc.compare_coords</span>
<span class="sd">        native numpy faster than explicit loops</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_frac_xyz</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">xyz</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span> <span class="c1"># coordinates distance</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
            <span class="n">dx</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span> <span class="c1"># pbc</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Euclidean distance</span>
        <span class="n">wd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">))</span> <span class="c1"># where of duplicates</span>
        <span class="c1">### print(np.vstack(wd).T) # for debug</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">wd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">wd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># index of duplicates</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="n">wd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">duplicates</span><span class="p">)</span> <span class="c1"># not needed but clearer; alto transform to list</span>
        <span class="k">return</span> <span class="n">duplicates</span></div>

<div class="viewcode-block" id="mol.remove_duplicates"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.remove_duplicates">[docs]</a>    <span class="k">def</span> <span class="nf">remove_duplicates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-03</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-03</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        remove duplicate atoms within given tolerances</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_duplicates</span><span class="p">(</span><span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">atol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_atoms</span><span class="p">(</span><span class="n">duplicates</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.merge_atoms"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.merge_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">merge_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sele</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">molecules_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        merge selected atoms</span>
<span class="sd">        sele(list of nested lists of int OR list of int): list of atom indices</span>
<span class="sd">        parent_index(int): index of parent atom in the selection which</span>
<span class="sd">            attributes are taken from (e.g. element, atomtype, etc.)</span>
<span class="sd">        molecules_flag(bool): if True: sele is regrouped accoring to the found</span>
<span class="sd">            molecules (e.g. if you select the COO of different carboxylates, each</span>
<span class="sd">            COO is merged per se). The same behavior can be reproduced with</span>
<span class="sd">            an appropriate nesting of sele, so consider molecules_flag a</span>
<span class="sd">            convenience flag.</span>
<span class="sd">            N.B.: this does NOT divide a selection of non-connected parts if</span>
<span class="sd">            those parts belong to the same molecule (e.g. linkers in a framework).</span>
<span class="sd">            In that case, you have to get_separated_molecules(sele) first to get</span>
<span class="sd">            the nested list of separated moieties.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sele</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># trivial if molecules_flag=False...</span>
            <span class="n">sele</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sele</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span> <span class="c1"># quick and dirt</span>
                <span class="n">sele</span> <span class="o">=</span> <span class="p">[</span><span class="n">sele</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="n">sele</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">sele</span><span class="p">,[])),</span>\
            <span class="s2">&quot;multiple occurring atom indices are NOT supported!&quot;</span>
        <span class="k">if</span> <span class="n">molecules_flag</span><span class="p">:</span>
            <span class="c1"># atoms are merged per connected components i.e. molecules</span>
            <span class="n">sele_molecules</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">molidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_separated_molecules</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">midx</span> <span class="ow">in</span> <span class="n">molidx</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sel</span> <span class="ow">in</span> <span class="n">sele</span><span class="p">:</span>
                    <span class="n">msel</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">midx</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">msel</span> <span class="o">!=</span> <span class="p">[]:</span>
                        <span class="n">sele_molecules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msel</span><span class="p">)</span>
            <span class="n">sele</span> <span class="o">=</span> <span class="n">sele_molecules</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">sele</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="n">sel</span><span class="p">[</span><span class="n">parent_index</span><span class="p">]</span>
                <span class="n">elem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elems</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
                <span class="n">atype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atypes</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragtypes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fragtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragtypes</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
                    <span class="n">fragnumber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">atype</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">fragtype</span><span class="o">=</span><span class="n">fragtype</span><span class="p">,</span> <span class="n">fragnumber</span><span class="o">=</span><span class="n">fragnumber</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">atype</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span>
                <span class="n">conn_all</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">],[])</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">conn_all</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">conn</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;TBI! [RA]&quot;</span><span class="p">)</span>
                    <span class="n">frac_xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_frac_xyz</span><span class="p">()</span>
                    <span class="n">frac_j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_xyz</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">conn</span><span class="p">:</span>
                        <span class="n">frac_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frac_xyz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">frac_j</span> <span class="o">-</span> <span class="n">frac_i</span><span class="p">)</span><span class="o">%</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">xyz_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">()</span>
                <span class="c1"># offset trick (not new: see delete_atoms)</span>
                <span class="c1"># trick must be performed BEFORE delete_atoms!</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">:</span>
                        <span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># one of the last call, taking care of conn indices!</span>
                <span class="c1"># N.B.: offset must be initialized before delete_atoms</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete_atoms</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
                <span class="c1"># back to the trick</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sele</span><span class="p">):</span>
                    <span class="n">sele</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="n">offset</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
        <span class="k">return</span> <span class="c1"># will never get it, here for clarity</span></div>

<div class="viewcode-block" id="mol.shuffle_atoms"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.shuffle_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">shuffle_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sele</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        shuffle atom indices, debug purpose</span>

<span class="sd">        :Arguments:</span>
<span class="sd">        sele(list of int): selection list of atom indices</span>
<span class="sd">            if sele is None: all the atoms are shuffled</span>

<span class="sd">        many methods should be INVARIANT wrt. atom sorting</span>
<span class="sd">        N.B.: using numpy array since for readability</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sele</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sele</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">))</span>
        <span class="n">sele_original</span> <span class="o">=</span> <span class="n">sele</span><span class="p">[:]</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">sele</span><span class="p">)</span>
        <span class="c1"># selection to original dictionary</span>
        <span class="n">sele2sele_original</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sele</span><span class="p">,</span> <span class="n">sele_original</span><span class="p">)))</span>
        <span class="c1"># coordinates #</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">sele_original</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">sele</span><span class="p">]</span>
        <span class="c1"># elements #</span>
        <span class="n">elems</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elems</span><span class="p">)</span>
        <span class="n">elems</span><span class="p">[</span><span class="n">sele_original</span><span class="p">]</span> <span class="o">=</span> <span class="n">elems</span><span class="p">[</span><span class="n">sele</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elems</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">elems</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
        <span class="c1"># atomtypes #</span>
        <span class="n">atypes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atypes</span><span class="p">)</span>
        <span class="n">atypes</span><span class="p">[</span><span class="n">sele_original</span><span class="p">]</span> <span class="o">=</span> <span class="n">atypes</span><span class="p">[</span><span class="n">sele</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atypes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">atypes</span><span class="p">]</span>
        <span class="c1"># connectivity #</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ic</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
            <span class="n">ic</span> <span class="o">=</span> <span class="p">[</span><span class="n">sele2sele_original</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">sele</span> <span class="k">else</span> <span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ic</span><span class="p">]</span>
            <span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ic</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">conn</span><span class="p">[</span><span class="n">sele_original</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span><span class="p">[</span><span class="n">sele</span><span class="p">][:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_conn</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">sele2sele_original</span></div>

<div class="viewcode-block" id="mol.get_separated_molecules"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_separated_molecules">[docs]</a>    <span class="k">def</span> <span class="nf">get_separated_molecules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sele</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get lists of indices of atoms which are connected together inside the</span>
<span class="sd">        list and not connected outside the list.</span>
<span class="sd">        same as get islands (see toper) with a native graph-tools algorithm</span>

<span class="sd">        :Arguments:</span>
<span class="sd">        sele(list of int): selection list of atom indices</span>
<span class="sd">            if sele is None: find molecules in the whole mol</span>
<span class="sd">            else: find molecules just in the selection, counting non-connected</span>
<span class="sd">                atoms as separated molecules (e.g. if you select just the</span>
<span class="sd">                COO of a paddlewheel you get 4 molecules)</span>

<span class="sd">        &gt;&gt;&gt; import molsys</span>
<span class="sd">        &gt;&gt;&gt; m = molsys.mol.from_file(&quot;molecules.mfpx&quot;)</span>
<span class="sd">        &gt;&gt;&gt; molecules_idx = m.get_separated_molecules()</span>
<span class="sd">        &gt;&gt;&gt; for m_idx in molecules_idx:</span>
<span class="sd">        &gt;&gt;&gt;     m.new_mol_by_index(m_idx).view()</span>
<span class="sd">        &gt;&gt;&gt; # if in trouble: CTRL+Z and &quot;kill %%&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">graph_tool.topology</span> <span class="kn">import</span> <span class="n">label_components</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;install graph-tool via &#39;pip install graph-tool&#39;&quot;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">molsys.util.toper</span> <span class="kn">import</span> <span class="n">molgraph</span>
        <span class="k">if</span> <span class="n">sele</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mg</span> <span class="o">=</span> <span class="n">molgraph</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_mol_by_index</span><span class="p">(</span><span class="n">sele</span><span class="p">)</span>
            <span class="n">mg</span> <span class="o">=</span> <span class="n">molgraph</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">label_components</span><span class="p">(</span><span class="n">mg</span><span class="o">.</span><span class="n">molg</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">unique_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Counter</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">sele</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">molidx</span> <span class="o">=</span> <span class="p">[[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">ej</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="k">if</span> <span class="n">ej</span><span class="o">==</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">molidx</span> <span class="o">=</span> <span class="p">[[</span><span class="n">sele</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">ej</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span> <span class="k">if</span> <span class="n">ej</span><span class="o">==</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">molidx</span></div>

<div class="viewcode-block" id="mol.check_periodic"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.check_periodic">[docs]</a>    <span class="k">def</span> <span class="nf">check_periodic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_periodic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        check whether mol is periodic</span>

<span class="sd">        :Arguments:</span>
<span class="sd">            set_periodic=False (bool): if True, set periodic as checked</span>

<span class="sd">        :Returns:</span>
<span class="sd">            periodic (bool): flag according to found periodicity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># unit cell</span>
        <span class="n">idxs_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_separated_molecules</span><span class="p">()</span>
        <span class="n">len_unit</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs_unit</span><span class="p">]</span>
        <span class="n">ulen_unit</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">len_unit</span><span class="p">)</span>
        <span class="c1"># supercell</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">make_supercell</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">idxs_super</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get_separated_molecules</span><span class="p">()</span>
        <span class="n">len_super</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs_super</span><span class="p">]</span>
        <span class="n">ulen_super</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">len_super</span><span class="p">)</span>
        <span class="c1"># compare</span>
        <span class="k">if</span> <span class="n">ulen_unit</span> <span class="o">!=</span> <span class="n">ulen_super</span><span class="p">:</span>
            <span class="n">periodic</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">periodic</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">set_periodic</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="o">=</span> <span class="n">periodic</span>
        <span class="k">return</span> <span class="n">periodic</span></div>
        
<div class="viewcode-block" id="mol.unwrap_box"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.unwrap_box">[docs]</a>    <span class="k">def</span> <span class="nf">unwrap_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check_periodic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">check_periodic</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_periodic</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">make_supercell</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">idxs_super</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get_separated_molecules</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">idxs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idxs_super</span><span class="p">):</span>
            <span class="n">m_super</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">new_mol_by_index</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
            <span class="n">target_imgs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">m_super</span><span class="o">.</span><span class="n">ptab</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">target_imgs</span> <span class="o">==</span> <span class="p">{</span><span class="mi">13</span><span class="p">}</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_imgs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># only infra-cell bonds</span>
                <span class="n">m_unwrapped</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">new_mol_by_index</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
                <span class="n">m_unwrapped</span><span class="o">.</span><span class="n">set_empty_cell</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">m_unwrapped</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="c1">### MANIPULATE GEOMETRY ########################################################</span>

<div class="viewcode-block" id="mol.randomize_coordinates"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.randomize_coordinates">[docs]</a>    <span class="k">def</span> <span class="nf">randomize_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">maxdr</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;randomizes existing  coordinates</span>
<span class="sd">            maxdr (float, optional): Defaults to 1.0. maximum displacement</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">()</span>
        <span class="n">xyz</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="n">maxdr</span><span class="p">,</span><span class="n">maxdr</span><span class="p">,</span><span class="n">xyz</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_xyz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_pbc</span><span class="p">(</span><span class="n">xyz</span><span class="p">))</span></div>

<div class="viewcode-block" id="mol.translate"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.translate">[docs]</a>    <span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">+=</span> <span class="n">vec</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.translate_frac"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.translate_frac">[docs]</a>    <span class="k">def</span> <span class="nf">translate_frac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span> <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">*</span><span class="n">vec</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.rotate_euler"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.rotate_euler">[docs]</a>    <span class="k">def</span> <span class="nf">rotate_euler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">euler</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">rotations</span><span class="o">.</span><span class="n">rotate_by_euler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">euler</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.rotate_triple"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.rotate_triple">[docs]</a>    <span class="k">def</span> <span class="nf">rotate_triple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triple</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">rotations</span><span class="o">.</span><span class="n">rotate_by_triple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">triple</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.center_com"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.center_com">[docs]</a>    <span class="k">def</span> <span class="nf">center_com</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_periodic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pbc</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; centers the molsys at the center of mass</span>
<span class="sd">            optionally: of given atomic indices</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">check_periodic</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_com</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">check_periodic</span><span class="o">=</span><span class="n">check_periodic</span><span class="p">,</span> <span class="n">pbc</span> <span class="o">=</span> <span class="n">pbc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="o">-</span><span class="n">center</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.center_coc"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.center_coc">[docs]</a>    <span class="k">def</span> <span class="nf">center_coc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_periodic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pbc</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; centers the molsys at the center of mass</span>
<span class="sd">            optionally: of given atomic indices</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">check_periodic</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coc</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">check_periodic</span><span class="o">=</span><span class="n">check_periodic</span><span class="p">,</span> <span class="n">pbc</span> <span class="o">=</span> <span class="n">pbc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="o">-</span><span class="n">center</span><span class="p">)</span>
        <span class="k">return</span></div>

    <span class="c1"># ??? needed? collapse into center_com? [RA]</span>
<div class="viewcode-block" id="mol.shift_by_com"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.shift_by_com">[docs]</a>    <span class="k">def</span> <span class="nf">shift_by_com</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        shift by center of mass</span>
<span class="sd">        alpha is needed otherwise atom distance is lost for excerpt of former</span>
<span class="sd">        periodic structures (e.g. a block)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ralpha</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">alpha</span>
        <span class="n">com</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_com</span><span class="p">(</span><span class="n">check_periodic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">com</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_cell</span><span class="p">)</span><span class="o">%</span><span class="n">ralpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># N.B.: reverse alpha has a different meaning</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="n">com</span><span class="o">*</span><span class="n">ralpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">-=</span> <span class="n">shift</span>
        <span class="k">return</span></div>

    <span class="c1">### DISTANCE MEASUREMENTS #######################</span>

<div class="viewcode-block" id="mol.get_distvec"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_distvec">[docs]</a>    <span class="k">def</span> <span class="nf">get_distvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="n">SMALL_DIST</span><span class="p">,</span><span class="n">return_all_r</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; vector from i to j</span>
<span class="sd">        This is a tricky bit, because it is needed also for distance detection in the blueprint</span>
<span class="sd">        where there can be small cell params wrt to the vertex distances.</span>
<span class="sd">        In other words: i can be bonded to j multiple times (each in a different image)</span>
<span class="sd">        and i and j could be the same!!</span>
<span class="sd">        :Parameters&#39;:</span>
<span class="sd">            - i,j  : the indices of the atoms for which the distance is to be calculated&quot;&quot;&quot;</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">rj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
            <span class="n">all_rj</span> <span class="o">=</span> <span class="n">rj</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_cellvec</span>
            <span class="n">all_r</span> <span class="o">=</span> <span class="n">all_rj</span> <span class="o">-</span> <span class="n">ri</span>
            <span class="n">all_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">all_r</span><span class="o">*</span><span class="n">all_r</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">d_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">all_d</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                <span class="c1"># if this was requested for i==j then we have to eliminate the shortest</span>
                <span class="c1"># distance</span>
                <span class="n">d_sort</span> <span class="o">=</span> <span class="n">d_sort</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">closest</span> <span class="o">=</span> <span class="n">d_sort</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">closest</span><span class="o">=</span><span class="p">[</span><span class="n">closest</span><span class="p">]</span>  <span class="c1"># THIS IS A BIT OF A HACK BUT WE MAKE IT ALWAYS A LIST ....</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">all_d</span><span class="p">[</span><span class="n">closest</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">-</span><span class="n">all_d</span><span class="p">[</span><span class="n">d_sort</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">):</span>
                <span class="c1"># oops ... there is more then one image atom in the same distance</span>
                <span class="c1">#  this means the distance is larger then half the cell width</span>
                <span class="c1"># in this case we have to return a list of distances</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d_sort</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">all_d</span><span class="p">[</span><span class="n">d_sort</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">-</span><span class="n">all_d</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">):</span>
                        <span class="n">closest</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">all_d</span><span class="p">[</span><span class="n">closest</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">all_r</span><span class="p">[</span><span class="n">closest</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span> <span class="k">return</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">rj</span><span class="o">-</span><span class="n">ri</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">))</span>
            <span class="n">closest</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">return_all_r</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">closest</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span><span class="p">,</span> <span class="n">all_r</span><span class="p">[</span><span class="n">closest</span><span class="p">],</span> <span class="n">closest</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">closest</span></div>

<div class="viewcode-block" id="mol.get_dist"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_dist">[docs]</a>    <span class="k">def</span> <span class="nf">get_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">rj</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="n">SMALL_DIST</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; vector from i to j</span>
<span class="sd">        This is a tricky bit, because it is needed also for distance detection in the blueprint</span>
<span class="sd">        where there can be small cell params wrt to the vertex distances.</span>
<span class="sd">        In other words: i can be bonded to j multiple times (each in a different image)</span>
<span class="sd">        and i and j could be the same!!</span>
<span class="sd">        :Parameters&#39;:</span>
<span class="sd">            - i,j  : the indices of the atoms for which the distance is to be calculated&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
            <span class="n">all_rj</span> <span class="o">=</span> <span class="n">rj</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_cellvec</span>
            <span class="n">all_r</span> <span class="o">=</span> <span class="n">all_rj</span> <span class="o">-</span> <span class="n">ri</span>
            <span class="n">all_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">all_r</span><span class="o">*</span><span class="n">all_r</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">d_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">all_d</span><span class="p">)</span>
            <span class="n">closest</span> <span class="o">=</span> <span class="n">d_sort</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">closest</span><span class="o">=</span><span class="p">[</span><span class="n">closest</span><span class="p">]</span>  <span class="c1"># THIS IS A BIT OF A HACK BUT WE MAKE IT ALWAYS A LIST ....</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">all_d</span><span class="p">[</span><span class="n">closest</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">-</span><span class="n">all_d</span><span class="p">[</span><span class="n">d_sort</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">):</span>
                <span class="c1"># oops ... there is more then one image atom in the same distance</span>
                <span class="c1">#  this means the distance is larger then half the cell width</span>
                <span class="c1"># in this case we have to return a list of distances</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d_sort</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">all_d</span><span class="p">[</span><span class="n">d_sort</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">-</span><span class="n">all_d</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">thresh</span><span class="p">):</span>
                        <span class="n">closest</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">all_d</span><span class="p">[</span><span class="n">closest</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">all_r</span><span class="p">[</span><span class="n">closest</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">rj</span><span class="o">-</span><span class="n">ri</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">))</span>
            <span class="n">closest</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">d</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">closest</span></div>

<div class="viewcode-block" id="mol.get_neighb_coords"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_neighb_coords">[docs]</a>    <span class="k">def</span> <span class="nf">get_neighb_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ci</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns coordinates of atom bonded to i which is ci&#39;th in bond list</span>
<span class="sd">        :Parameters:</span>
<span class="sd">            - i  :  index of the base atom</span>
<span class="sd">            - ci :  index of the conn entry of the ith atom&quot;&quot;&quot;</span>
        <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ci</span><span class="p">]</span>
        <span class="n">rj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ci</span><span class="p">]</span>
                <span class="n">rj</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_rj</span> <span class="o">=</span> <span class="n">rj</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_cellvec</span>
                <span class="n">all_r</span> <span class="o">=</span> <span class="n">all_rj</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">all_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">all_r</span><span class="o">*</span><span class="n">all_r</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">closest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">all_d</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">all_rj</span><span class="p">[</span><span class="n">closest</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">rj</span></div>

<div class="viewcode-block" id="mol.get_neighb_coords_"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_neighb_coords_">[docs]</a>    <span class="k">def</span> <span class="nf">get_neighb_coords_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns coordinates of atom bonded to i which is ci&#39;th in bond list</span>
<span class="sd">        TBI: merge get_neighb_coords and get_neighb_coords_</span>
<span class="sd">        :Parameters:</span>
<span class="sd">            - i   :  index of base atom</span>
<span class="sd">            - ci  :  index of bond atom</span>
<span class="sd">            - img :  cell image&quot;&quot;&quot;</span>
        <span class="n">rj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
                <span class="n">rj</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_rj</span> <span class="o">=</span> <span class="n">rj</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_cellvec</span>
                <span class="n">all_r</span> <span class="o">=</span> <span class="n">all_rj</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">all_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">all_r</span><span class="o">*</span><span class="n">all_r</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">closest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">all_d</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">all_rj</span><span class="p">[</span><span class="n">closest</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">rj</span></div>

<div class="viewcode-block" id="mol.get_neighb_dist"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_neighb_dist">[docs]</a>    <span class="k">def</span> <span class="nf">get_neighb_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ci</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; returns the distance of atom bonded to i which is ci&#39;th in bond list</span>
<span class="sd">        :Parameters:</span>
<span class="sd">            - i  :  index of the base atom</span>
<span class="sd">            - ci :  index of the conn entry of the ith atom&quot;&quot;&quot;</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ci</span><span class="p">]</span>
        <span class="n">rj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ci</span><span class="p">]</span>
                <span class="n">rj</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_rj</span> <span class="o">=</span> <span class="n">rj</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_cellvec</span>
                <span class="n">all_r</span> <span class="o">=</span> <span class="n">all_rj</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">all_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">all_r</span><span class="o">*</span><span class="n">all_r</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">closest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">all_d</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">all_d</span><span class="p">[</span><span class="n">closest</span><span class="p">]</span>
        <span class="n">dr</span> <span class="o">=</span> <span class="n">ri</span><span class="o">-</span><span class="n">rj</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dr</span><span class="o">*</span><span class="n">dr</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="mol.get_comdist"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_comdist">[docs]</a>    <span class="k">def</span> <span class="nf">get_comdist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">com</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Calculate the distances of an atom i from a given point (e.g. the center of mass)</span>
<span class="sd">        :Parameters:</span>
<span class="sd">            - com : center of mass</span>
<span class="sd">            - i   : index of the atom for which to calculate the distances to the com&#39;&#39;&#39;</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">rj</span> <span class="o">=</span> <span class="n">com</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
            <span class="n">all_rj</span> <span class="o">=</span> <span class="n">rj</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_cellvec</span>
            <span class="n">all_r</span> <span class="o">=</span> <span class="n">all_rj</span> <span class="o">-</span> <span class="n">ri</span>
            <span class="n">all_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">all_r</span><span class="o">*</span><span class="n">all_r</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">d_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">all_d</span><span class="p">)</span>
            <span class="n">closest</span> <span class="o">=</span> <span class="n">d_sort</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">closest</span><span class="o">=</span><span class="p">[</span><span class="n">closest</span><span class="p">]</span>  <span class="c1"># THIS IS A BIT OF A HACK BUT WE MAKE IT ALWAYS A LIST ....</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">all_d</span><span class="p">[</span><span class="n">closest</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">-</span><span class="n">all_d</span><span class="p">[</span><span class="n">d_sort</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">&lt;</span> <span class="n">SMALL_DIST</span><span class="p">):</span>
                <span class="c1"># oops ... there is more then one image atom in the same distance</span>
                <span class="c1">#  this means the distance is larger then half the cell width</span>
                <span class="c1"># in this case we have to return a list of distances</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d_sort</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">all_d</span><span class="p">[</span><span class="n">d_sort</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">-</span><span class="n">all_d</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">SMALL_DIST</span><span class="p">):</span>
                        <span class="n">closest</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">all_d</span><span class="p">[</span><span class="n">closest</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">all_r</span><span class="p">[</span><span class="n">closest</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">rj</span><span class="o">-</span><span class="n">ri</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="n">r</span><span class="p">))</span>
            <span class="n">closest</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">d</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">closest</span></div>

<div class="viewcode-block" id="mol.get_com"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_com">[docs]</a>    <span class="k">def</span> <span class="nf">get_com</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">xyz</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_periodic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pbc</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the center of mass of the mol object.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            idx  (list): list of atomindices to calculate the center of mass of a subset of atoms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;masstype&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_real_mass</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">amass</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">amass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">amass</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">amass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">amass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amass</span>
        <span class="k">if</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">amass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">amass</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="ow">and</span> <span class="n">check_periodic</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">()</span>
            <span class="n">amass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">amass</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">amass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">amass</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pbc</span><span class="p">:</span> <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_pbc</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">amass</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xyz</span><span class="o">*</span><span class="n">amass</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">amass</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1">#every atom is dummy! so it counts as one</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">amass</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">center</span></div>

<div class="viewcode-block" id="mol.get_coc"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_coc">[docs]</a>    <span class="k">def</span> <span class="nf">get_coc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">xyz</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">check_periodic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pbc</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the center of coordinates (centroid) of the mol object.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            idx  (list): list of atomindices to calculate the center of coordinates of a subset of atoms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">periodic</span> <span class="ow">and</span> <span class="n">check_periodic</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">()</span>
            <span class="n">natoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">()[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pbc</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_pbc</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">natoms</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">natoms</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">center</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;get_coc requires at least one atom to be present in the mol instance. returning zero vector&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">])</span></div>

    <span class="c1">### CORE DATASTRUCTURES #######################################</span>

<div class="viewcode-block" id="mol.get_natoms"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_natoms">[docs]</a>    <span class="k">def</span> <span class="nf">get_natoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; returns the number of Atoms &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span></div>

<div class="viewcode-block" id="mol.set_natoms"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_natoms">[docs]</a>    <span class="k">def</span> <span class="nf">set_natoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">natoms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; sets the number of atoms for a new moltype &quot;&quot;&quot;</span>
        <span class="c1">#assert self.natoms == 0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span> <span class="o">=</span> <span class="n">natoms</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.get_xyz"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_xyz">[docs]</a>    <span class="k">def</span> <span class="nf">get_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; returns the xyz Coordinates</span>

<span class="sd">        Args:</span>
<span class="sd">            idx=None (list): optional list of indices</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></div>

<div class="viewcode-block" id="mol.set_xyz"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_xyz">[docs]</a>    <span class="k">def</span> <span class="nf">set_xyz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">xyz</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; set the real xyz coordinates</span>
<span class="sd">        Args:</span>
<span class="sd">            xyz (array): coordinates to be set</span>
<span class="sd">            idx=None (list): optional list of indicies</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">xyz</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">xyz</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">xyz</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyz</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.get_sumformula"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_sumformula">[docs]</a>    <span class="k">def</span> <span class="nf">get_sumformula</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the sumformula of the mol object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fsum</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">unielems</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elems</span><span class="p">)))</span>
        <span class="n">elemscount</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">elems</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unielems</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unielems</span><span class="p">):</span>
            <span class="n">fe</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">+</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">fsum</span> <span class="o">+=</span> <span class="n">fe</span>
            <span class="n">fsum</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">elemscount</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">fsum</span></div>

<div class="viewcode-block" id="mol.get_elems"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_elems">[docs]</a>    <span class="k">def</span> <span class="nf">get_elems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; return the list of element symbols &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">elems</span></div>

<div class="viewcode-block" id="mol.get_elems_number"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_elems_number">[docs]</a>    <span class="k">def</span> <span class="nf">get_elems_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; return a list of atomic numbers &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">elements</span><span class="o">.</span><span class="n">number</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elems</span><span class="p">]</span></div>

<div class="viewcode-block" id="mol.get_elemlist"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_elemlist">[docs]</a>    <span class="k">def</span> <span class="nf">get_elemlist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Returns a list of unique elements &#39;&#39;&#39;</span>
        <span class="n">el</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elems</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">el</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">e</span><span class="p">):</span> <span class="n">el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">el</span></div>

<div class="viewcode-block" id="mol.set_elems"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_elems">[docs]</a>    <span class="k">def</span> <span class="nf">set_elems</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elems</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; set the elements</span>
<span class="sd">        :Parameters:</span>
<span class="sd">            - elems: list of elements to be set&#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">elems</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elems</span> <span class="o">=</span> <span class="n">elems</span></div>

<div class="viewcode-block" id="mol.set_elems_number"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_elems_number">[docs]</a>    <span class="k">def</span> <span class="nf">set_elems_number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elems_number</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; set the elements from a list of atomic numbers &quot;&quot;</span>
<span class="sd">        :Parameters:</span>
<span class="sd">            - elem_number: list of atomic numbers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">elems_number</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elems</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">elements</span><span class="o">.</span><span class="n">number</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">elems_number</span><span class="p">]</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.get_atypes"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_atypes">[docs]</a>    <span class="k">def</span> <span class="nf">get_atypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; return the list of atom types &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">atypes</span></div>

<div class="viewcode-block" id="mol.get_natypes"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_natypes">[docs]</a>    <span class="k">def</span> <span class="nf">get_natypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">atypes</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atypes</span><span class="p">))</span></div>

    <span class="c1"># just to make compatible with pydlpoly standard API</span>
<div class="viewcode-block" id="mol.get_atomtypes"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_atomtypes">[docs]</a>    <span class="k">def</span> <span class="nf">get_atomtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">atypes</span></div>

<div class="viewcode-block" id="mol.get_atypelist"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_atypelist">[docs]</a>    <span class="k">def</span> <span class="nf">get_atypelist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Returns a list of unique atom types &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">atypes</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_atypes</span><span class="p">()))</span></div>

<div class="viewcode-block" id="mol.set_atypes"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_atypes">[docs]</a>    <span class="k">def</span> <span class="nf">set_atypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">atypes</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; set the atomtypes</span>
<span class="sd">        :Parameters:</span>
<span class="sd">            - atypes: list of elements to be set&#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">atypes</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atypes</span> <span class="o">=</span> <span class="n">atypes</span></div>

<div class="viewcode-block" id="mol.get_fragtypes"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_fragtypes">[docs]</a>    <span class="k">def</span> <span class="nf">get_fragtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; return all fragment types &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragtypes</span></div>

<div class="viewcode-block" id="mol.get_fragtypes_list"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_fragtypes_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_fragtypes_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; return a list of unique fragment types &#39;&#39;&#39;</span>
        <span class="n">lset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragtypes</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">count</span><span class="p">:</span> <span class="k">return</span> <span class="n">lset</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ls</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lset</span><span class="p">):</span>
            <span class="n">counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragtypes</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">ls</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">lset</span><span class="p">,</span><span class="n">counts</span><span class="p">]</span></div>

<div class="viewcode-block" id="mol.set_fragtypes"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_fragtypes">[docs]</a>    <span class="k">def</span> <span class="nf">set_fragtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fragtypes</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; set fragment types</span>
<span class="sd">        :Parameters:</span>
<span class="sd">            - fragtypes: the fragtypes to be set (list of strings)&#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fragtypes</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fragtypes</span> <span class="o">=</span> <span class="n">fragtypes</span></div>

<div class="viewcode-block" id="mol.get_fragnumbers"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_fragnumbers">[docs]</a>    <span class="k">def</span> <span class="nf">get_fragnumbers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; return all fragment numbers, denotes which atom belongs to which fragment &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span></div>

<div class="viewcode-block" id="mol.set_fragnumbers"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_fragnumbers">[docs]</a>    <span class="k">def</span> <span class="nf">set_fragnumbers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fragnumbers</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; set fragment numbers, denotes which atom belongs to which fragment</span>
<span class="sd">        :Parameters:</span>
<span class="sd">            - fragnumbers: the fragment numbers to be set (list of integers)&#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fragnumbers</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span> <span class="o">=</span> <span class="n">fragnumbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfrags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span></div>

<div class="viewcode-block" id="mol.get_nfrags"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_nfrags">[docs]</a>    <span class="k">def</span> <span class="nf">get_nfrags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the number of fragments in the actual system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#return self.nfrags</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span></div>

<div class="viewcode-block" id="mol.add_fragnumbers"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.add_fragnumbers">[docs]</a>    <span class="k">def</span> <span class="nf">add_fragnumbers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fragnumbers</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        adds a set of fragnumbers to the actual system</span>
<span class="sd">        :Parameters:</span>
<span class="sd">            - fragnumbers: the fragment numbers to be set (list of integers)&#39;&#39;&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fragnumbers</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">get_nfrags</span><span class="p">()</span>
            <span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span> <span class="o">=</span> <span class="n">fragnumbers</span>
        <span class="c1">#self.fragnumbers += list(np.array(fragnumbers)+self.get_nfrags())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfrags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fragnumbers</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>  
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.add_fragtypes"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.add_fragtypes">[docs]</a>    <span class="k">def</span> <span class="nf">add_fragtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fragtypes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        adds a set of fragntpyes to the actual system</span>
<span class="sd">        :Parameters:</span>
<span class="sd">            - fragtypes: the fragtypes to be set (list of strings)&#39;&#39;&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fragtypes</span> <span class="o">+=</span> <span class="n">fragtypes</span>
        <span class="k">return</span></div>

    <span class="c1">### CONNECTIVITY ###########################################################</span>

<div class="viewcode-block" id="mol.get_conn"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_conn">[docs]</a>    <span class="k">def</span> <span class="nf">get_conn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; returns the connectivity of the system &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span></div>

<div class="viewcode-block" id="mol.set_conn"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_conn">[docs]</a>    <span class="k">def</span> <span class="nf">set_conn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">ctab_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; updates the connectivity of the system</span>
<span class="sd">        :Parameters:</span>
<span class="sd">            - conn    : List of lists describing the connectivity&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span>
        <span class="k">if</span> <span class="n">ctab_flag</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_conn_as_tab</span><span class="p">()</span></div>

<div class="viewcode-block" id="mol.get_ctab"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_ctab">[docs]</a>    <span class="k">def</span> <span class="nf">get_ctab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; returns the connectivity table (nbonds, 2)&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctab</span></div>

<div class="viewcode-block" id="mol.set_ctab"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_ctab">[docs]</a>    <span class="k">def</span> <span class="nf">set_ctab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctab</span><span class="p">,</span> <span class="n">conn_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; updates the connectivity table</span>
<span class="sd">        :Parameters:</span>
<span class="sd">            - ctab  : List of couples describing the connectivity&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctab</span> <span class="o">=</span> <span class="n">ctab</span>
        <span class="k">if</span> <span class="n">conn_flag</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_conn_from_tab</span><span class="p">(</span><span class="n">ctab</span><span class="p">)</span></div>

<div class="viewcode-block" id="mol.set_empty_conn"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_empty_conn">[docs]</a>    <span class="k">def</span> <span class="nf">set_empty_conn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets an empty list of lists for the connectivity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.get_conn_as_tab"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_conn_as_tab">[docs]</a>    <span class="k">def</span> <span class="nf">get_conn_as_tab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pconn_flag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        gets the connectivity as a table of bonds with shape (nbonds, 2)</span>
<span class="sd">        N.B.: can return ctab AND ptab if self.use_pconn == True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pconn_flag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">pconn_flag</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s2">&quot;use_pconn&quot;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ctab</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ptab</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">pconn_flag</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
                <span class="n">ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">pi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">pj</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span><span class="n">pi</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">i</span> <span class="ow">or</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="n">i</span> <span class="ow">and</span> <span class="n">arr2idx</span><span class="p">[</span><span class="n">pj</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">):</span>
                        <span class="n">ctab</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span>
                        <span class="n">ptab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr2idx</span><span class="p">[</span><span class="n">pj</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">ctab</span><span class="p">,</span> <span class="n">ptab</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ci</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                        <span class="n">ctab</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ctab</span></div>

<div class="viewcode-block" id="mol.set_ctab_from_conn"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_ctab_from_conn">[docs]</a>    <span class="k">def</span> <span class="nf">set_ctab_from_conn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pconn_flag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pconn_flag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">pconn_flag</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s2">&quot;use_pconn&quot;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pconn_flag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ctab</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_conn_as_tab</span><span class="p">(</span><span class="n">pconn_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ctab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_conn_as_tab</span><span class="p">(</span><span class="n">pconn_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="mol.set_conn_from_tab"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_conn_from_tab">[docs]</a>    <span class="k">def</span> <span class="nf">set_conn_from_tab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctab</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets the connectivity from a table of bonds</span>
<span class="sd">        :Parameters:</span>
<span class="sd">            - ctab   : list of bonds (nbonds, 2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_empty_conn</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbonds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctab</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ctab</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">c</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.get_unique_neighbors"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_unique_neighbors">[docs]</a>    <span class="k">def</span> <span class="nf">get_unique_neighbors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">un</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">cc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                <span class="n">neighs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">atypes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">atypes</span><span class="p">[</span><span class="n">cc</span><span class="p">]])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ii</span><span class="o">=</span><span class="n">un</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">neighs</span><span class="p">)</span>
                    <span class="n">counter</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">un</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neighs</span><span class="p">)</span>
                    <span class="n">counter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique_neighbors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">un</span><span class="p">)):</span>  
            <span class="bp">self</span><span class="o">.</span><span class="n">unique_neighbors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">un</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">counter</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_neighbors</span></div>

    <span class="c1">### PERIODIC CONNECTIVITY ###</span>
<div class="viewcode-block" id="mol.get_pconn"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_pconn">[docs]</a>    <span class="k">def</span> <span class="nf">get_pconn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; returns the periodic connectivity of the system &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span></div>

<div class="viewcode-block" id="mol.set_pconn"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_pconn">[docs]</a>    <span class="k">def</span> <span class="nf">set_pconn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pconn</span><span class="p">,</span> <span class="n">ptab_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; updates the periodic connectivity of the system</span>
<span class="sd">        :Parameters:</span>
<span class="sd">            - pconn    : List of lists describing the periodic connectivity&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span> <span class="o">=</span> <span class="n">pconn</span>
        <span class="k">if</span> <span class="n">ptab_flag</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pconn_as_tab</span><span class="p">()</span></div>

<div class="viewcode-block" id="mol.get_ptab"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_ptab">[docs]</a>    <span class="k">def</span> <span class="nf">get_ptab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; returns the periodic connectivity table (nbonds, 2)&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptab</span></div>

<div class="viewcode-block" id="mol.set_ptab"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_ptab">[docs]</a>    <span class="k">def</span> <span class="nf">set_ptab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ptab</span><span class="p">,</span> <span class="n">pconn_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; updates the periodic connectivity table</span>
<span class="sd">        :Parameters:</span>
<span class="sd">            - ptab  : List of couples describing the periodic connectivity&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ptab</span> <span class="o">=</span> <span class="n">ptab</span>
        <span class="k">if</span> <span class="n">pconn_flag</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_pconn_from_tab</span><span class="p">(</span><span class="n">ptab</span><span class="p">)</span></div>

<div class="viewcode-block" id="mol.set_empty_pconn"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_empty_pconn">[docs]</a>    <span class="k">def</span> <span class="nf">set_empty_pconn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets an empty list of lists for the periodic connectivity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_empty_pimages</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.set_empty_pimages"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_empty_pimages">[docs]</a>    <span class="k">def</span> <span class="nf">set_empty_pimages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets an empty list of lists for the periodic connected images</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pimages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pimages</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.get_pconn_as_tab"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_pconn_as_tab">[docs]</a>    <span class="k">def</span> <span class="nf">get_pconn_as_tab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pconn_flag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        gets the periodic connectivity as a table of bonds with shape (nbonds, 2)</span>
<span class="sd">        N.B.: can return ctab AND ptab if self.use_pconn == True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">### TBI ### [RA]</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Use get_conn_as_Tab w/ pconn_flag=True&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pconn_flag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">pconn_flag</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s2">&quot;use_pconn&quot;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ctab</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ptab</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">pconn_flag</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
                <span class="n">ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">pi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pimages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">pj</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span><span class="n">pi</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">i</span> <span class="ow">or</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="n">i</span> <span class="ow">and</span> <span class="n">pj</span> <span class="o">&lt;=</span> <span class="mi">13</span><span class="p">):</span>
                        <span class="n">ctab</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                        <span class="n">ptab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pj</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ctab</span><span class="p">,</span> <span class="n">ptab</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ci</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                        <span class="n">ctab</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">ctab</span></div>

<div class="viewcode-block" id="mol.set_ptab_from_pconn"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_ptab_from_pconn">[docs]</a>    <span class="k">def</span> <span class="nf">set_ptab_from_pconn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pconn_flag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Use set_ctab_from_conn w/ pconn_flag=True&quot;</span><span class="p">)</span>
        <span class="c1"># TBI: see acab for a suggested implementation [RA]</span>
        <span class="k">if</span> <span class="n">pconn_flag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">pconn_flag</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s2">&quot;use_pconn&quot;</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pconn_flag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ctab</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_conn_as_tab</span><span class="p">(</span><span class="n">pconn_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ctab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_conn_as_tab</span><span class="p">(</span><span class="n">pconn_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="mol.set_pconn_from_tab"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_pconn_from_tab">[docs]</a>    <span class="k">def</span> <span class="nf">set_pconn_from_tab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ptab</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets the periodic connectivity froma table of bonds</span>
<span class="sd">        :Parameters:</span>
<span class="sd">            - ptab   : list of peridioc images per bond (nbonds, 2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;ctab&quot;</span><span class="p">),</span> <span class="s2">&quot;ctab is needed for the method&quot;</span>
        <span class="c1">#self.set_empty_pconn()</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">]</span>
        <span class="n">pconn</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">]</span>
        <span class="c1"># unique bond occurrence</span>
        <span class="n">uctab</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctab</span><span class="p">)</span>
        <span class="c1"># keep bond occurrence</span>
        <span class="n">dctab</span> <span class="o">=</span> <span class="p">{</span><span class="n">uc</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">uc</span> <span class="ow">in</span> <span class="n">uctab</span><span class="p">}</span>
        <span class="c1"># count occurrence</span>
        <span class="n">cctab</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctab</span><span class="p">]</span>
        <span class="c1"># store old occurrence</span>
        <span class="n">octab</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctab</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ic</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctab</span><span class="p">):</span>
            <span class="n">dctab</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">cctab</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dctab</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ptab</span><span class="p">):</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctab</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">ij</span><span class="p">,</span><span class="n">ji</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="c1"># for first occurrence</span>
            <span class="c1">#print(k,p)</span>
            <span class="c1"># get w-th occurrence</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cctab</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">ij</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">ij</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># add 1 to get next</span>
                <span class="n">ji</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">ji</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># add 1 to get next</span>
                <span class="c1">#print(w, ij,ji)</span>
            <span class="n">ij</span><span class="p">,</span><span class="n">ji</span> <span class="o">=</span> <span class="n">ij</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ji</span><span class="o">-</span><span class="mi">1</span> <span class="c1"># back to last finding</span>
            <span class="n">pconn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">ij</span><span class="p">]</span> <span class="o">=</span>  <span class="n">idx2arr</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
            <span class="n">pconn</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">ji</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">idx2arr</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span> <span class="o">=</span> <span class="n">pconn</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.get_pimages"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_pimages">[docs]</a>    <span class="k">def</span> <span class="nf">get_pimages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return the indices of the periodic images of the system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pimages</span></div>

<div class="viewcode-block" id="mol.set_pimages"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_pimages">[docs]</a>    <span class="k">def</span> <span class="nf">set_pimages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pimages</span><span class="p">,</span> <span class="n">pconn_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets periodic image indices</span>
<span class="sd">        if pconn_flag: set periodic connectivity (arrays) from indices</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pimages</span> <span class="o">=</span> <span class="n">pimages</span>
        <span class="k">if</span> <span class="n">pconn_flag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span> <span class="o">=</span><span class="p">[[</span><span class="n">idx2arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">pimagesi</span><span class="p">]</span> <span class="k">for</span> <span class="n">pimagesi</span> <span class="ow">in</span> <span class="n">pimages</span><span class="p">]</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.set_pimages_from_pconn"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_pimages_from_pconn">[docs]</a>    <span class="k">def</span> <span class="nf">set_pimages_from_pconn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pconn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets periodic image indices from periodic connectivity (arrays)</span>
<span class="sd">        if pconn is None: get pconn from instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pconn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pconn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pconn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pimages</span> <span class="o">=</span> <span class="p">[[</span><span class="n">arr2idx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">pconni</span><span class="p">]</span> <span class="k">for</span> <span class="n">pconni</span> <span class="ow">in</span> <span class="n">pconn</span><span class="p">]</span>
        <span class="k">return</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">etab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; edge tab&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_etab</span>

    <span class="nd">@etab</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">etab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etab</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;any time edge tab is set, ctab, (ptab) and etab are sorted&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_etab</span> <span class="o">=</span> <span class="n">etab</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbonds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">etab</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_tabs</span><span class="p">(</span><span class="n">etab_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<div class="viewcode-block" id="mol.set_etab_from_tabs"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_etab_from_tabs">[docs]</a>    <span class="k">def</span> <span class="nf">set_etab_from_tabs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctab</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ptab</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">conn_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set etab from ctab (and ptab). Both can be given or got from mol.</span>
<span class="sd">        if sort_flag: ctab, (ptab) and etab are sorted too.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ctab</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ptab</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ctab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctab</span>
            <span class="n">ptab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptab</span>
        <span class="k">elif</span> <span class="n">ctab</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ptab</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ctab and ptab can&#39;t both be None&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
            <span class="n">etab_T</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">ctab</span><span class="p">))</span>
            <span class="n">etab_T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ptab</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">etab</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">etab_T</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">etab</span> <span class="o">=</span> <span class="n">ctab</span><span class="p">[:]</span>
        <span class="k">if</span> <span class="n">sort_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span> <span class="c1">#it sorts ctab, ptab, and etab too</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sort_tabs</span><span class="p">(</span><span class="n">etab_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">conn_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_conn_from_tab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctab</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_pconn_from_tab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ptab</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.set_etab_from_conns"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_etab_from_conns">[docs]</a>    <span class="k">def</span> <span class="nf">set_etab_from_conns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pimages</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set etab from connectivity tables&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pimages</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span>
            <span class="n">pimages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pimages</span>
        <span class="k">elif</span> <span class="n">conn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pimages</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;conn and pimages can&#39;t both be None&quot;</span><span class="p">)</span>
        <span class="c1">### if no pconn: etab is ctab, then return ###</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_ctab_from_conn</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">etab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctab</span>
            <span class="k">return</span>
        <span class="c1">### if conn length is 0: etab is ctab, then return ###</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">etab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctab</span><span class="p">[:]</span>
            <span class="k">return</span>
        <span class="c1"># all the possible edges (redudant)</span>
        <span class="n">etab_red</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([[(</span><span class="n">ii</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">pimages</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">])</span> <span class="k">for</span> <span class="n">jj</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">conn</span><span class="p">)],[])</span>
        <span class="c1"># if no bond is found</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">etab_red</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ctab</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ptab</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">etab</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">return</span>
        <span class="c1"># if any bond is found</span>
        <span class="c1"># edit by convention:</span>
        <span class="c1">#    1)i &lt; j</span>
        <span class="c1">#    2)k &lt;= 13 if i == j</span>
        <span class="n">etab_selfcount</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># here only for future assertion</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">etab_red</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">j</span><span class="p">:</span> <span class="c1"># convention</span>
                <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="p">,</span><span class="n">i</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">idx2revidx</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">etab_red</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">13</span><span class="p">:</span> <span class="c1"># convention</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">idx2revidx</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">etab_red</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                <span class="n">etab_selfcount</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">etab_unique</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">etab_red</span><span class="p">)</span>
        <span class="n">etab_unique</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">etab_unique</span><span class="p">))</span> <span class="c1"># by convention</span>
        <span class="n">ictab</span><span class="p">,</span> <span class="n">jctab</span><span class="p">,</span> <span class="n">ptab</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">etab_unique</span><span class="p">))</span>
        <span class="n">ctab</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ictab</span><span class="p">,</span> <span class="n">jctab</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctab</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ctab</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ptab</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ptab</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etab</span> <span class="o">=</span> <span class="n">etab_unique</span> <span class="c1"># already a list</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.set_etab"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_etab">[docs]</a>    <span class="k">def</span> <span class="nf">set_etab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctab</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ptab</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set etab without sorting (sorting is default for etab.setter)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ctab</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ptab</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ctab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctab</span>
            <span class="n">ptab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptab</span>
        <span class="k">elif</span> <span class="n">ctab</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ptab</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ctab and ptab can&#39;t both be None&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
            <span class="n">etab</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">ctab</span><span class="p">))</span><span class="o">+</span><span class="p">[</span><span class="n">ptab</span><span class="p">])))</span> <span class="c1"># python3 compl.: zip iterator gets exhausted</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">etab</span> <span class="o">=</span> <span class="n">ctab</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_etab</span> <span class="o">=</span> <span class="n">etab</span></div>

<div class="viewcode-block" id="mol.sort_tabs"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.sort_tabs">[docs]</a>    <span class="k">def</span> <span class="nf">sort_tabs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etab_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">conn_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;sort ctab, (ptab) and etab according to given convention</span>
<span class="sd">        Convention is the following:</span>
<span class="sd">            1)first ctab atom is lower or equal than the second</span>
<span class="sd">            2)if i and j are equal and there is pconn:</span>
<span class="sd">                revert the image to an index lower than 13 (the current cell)</span>
<span class="sd">        N.B. this sorting is stable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">etab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">etab</span>
        <span class="n">ctab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctab</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
            <span class="n">ptab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptab</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ctab</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">j</span><span class="p">:</span>
                    <span class="n">ctab</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctab</span><span class="p">[</span><span class="n">ii</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">ptab</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx2revidx</span><span class="p">[</span><span class="n">ptab</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span> <span class="ow">and</span> <span class="n">ptab</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">13</span><span class="p">:</span>
                    <span class="n">ptab</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx2revidx</span><span class="p">[</span><span class="n">ptab</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>
            <span class="n">tosort</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">ctab</span><span class="p">))</span><span class="o">+</span><span class="p">[</span><span class="n">ptab</span><span class="p">])))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ctab</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">j</span><span class="p">:</span>
                    <span class="n">ctab</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctab</span><span class="p">[</span><span class="n">ii</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">tosort</span> <span class="o">=</span> <span class="n">ctab</span>
        <span class="n">asorted</span> <span class="o">=</span> <span class="n">argsorted</span><span class="p">(</span><span class="n">tosort</span><span class="p">)</span>
        <span class="n">ctab_</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctab</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">asorted</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_ctab</span><span class="p">(</span><span class="n">ctab_</span><span class="p">,</span> <span class="n">conn_flag</span><span class="o">=</span><span class="n">conn_flag</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
            <span class="n">ptab_</span> <span class="o">=</span> <span class="p">[</span><span class="n">ptab</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">asorted</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_ptab</span><span class="p">(</span><span class="n">ptab_</span><span class="p">,</span> <span class="n">pconn_flag</span><span class="o">=</span><span class="n">conn_flag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">etab_flag</span><span class="p">:</span> <span class="c1"># it ensures sorted etab and overwrites previous etab</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_etab_from_tabs</span><span class="p">(</span><span class="n">sort_flag</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">etab</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_etab</span> <span class="o">=</span> <span class="p">[</span><span class="n">etab</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">asorted</span><span class="p">]</span>
        <span class="k">return</span></div>

    <span class="c1">### UTILS ##################################################################</span>
<div class="viewcode-block" id="mol.set_unit_mass"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_unit_mass">[docs]</a>    <span class="k">def</span> <span class="nf">set_unit_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets the mass for every atom to one</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masstype</span> <span class="o">=</span> <span class="s1">&#39;unit&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amass</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">amass</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.set_real_mass"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_real_mass">[docs]</a>    <span class="k">def</span> <span class="nf">set_real_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets the physical mass for every atom</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masstype</span> <span class="o">=</span> <span class="s1">&#39;real&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amass</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elems</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">amass</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elements</span><span class="o">.</span><span class="n">mass</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">amass</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.get_mass"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_mass">[docs]</a>    <span class="k">def</span> <span class="nf">get_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_masstype</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the mass for every atom as list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">return_masstype</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">amass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">masstype</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">amass</span></div>

<div class="viewcode-block" id="mol.get_masstype"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_masstype">[docs]</a>    <span class="k">def</span> <span class="nf">get_masstype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">masstype</span></div>

<div class="viewcode-block" id="mol.set_mass"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_mass">[docs]</a>    <span class="k">def</span> <span class="nf">set_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">masstype</span><span class="o">=</span><span class="s1">&#39;real&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        returns the mass for every atom as list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amass</span> <span class="o">=</span> <span class="n">mass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masstype</span> <span class="o">=</span> <span class="n">masstype</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.set_nofrags"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_nofrags">[docs]</a>    <span class="k">def</span> <span class="nf">set_nofrags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; in case there are no fragment types and numbers, setup the data</span>
<span class="sd">        structure which is needed in some functions &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_fragtypes</span><span class="p">([</span><span class="s1">&#39;-1&#39;</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_fragnumbers</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">)</span></div>

<div class="viewcode-block" id="mol.get_comm"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_comm">[docs]</a>    <span class="k">def</span> <span class="nf">get_comm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; dummy call ... returns None ...</span>
<span class="sd">        for compatibility with pydlpoly system objects &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="mol.set_weight"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_weight">[docs]</a>    <span class="k">def</span> <span class="nf">set_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weight</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; sets the weight of the system</span>
<span class="sd">        :Parameters:</span>
<span class="sd">            - weight    : int/float&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.get_weight"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_weight">[docs]</a>    <span class="k">def</span> <span class="nf">get_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; gets the weight of the system. Default: 1.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span></div>

    <span class="c1">### PROPERTIES #############################################################</span>

<div class="viewcode-block" id="mol.get_atom_property"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_atom_property">[docs]</a>    <span class="k">def</span> <span class="nf">get_atom_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pname</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aprops</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span></div>

<div class="viewcode-block" id="mol.set_atom_property"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_atom_property">[docs]</a>    <span class="k">def</span> <span class="nf">set_atom_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pname</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span> <span class="o">=</span> <span class="n">Property</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span> <span class="s2">&quot;atom&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aprops</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.del_atom_property"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.del_atom_property">[docs]</a>    <span class="k">def</span> <span class="nf">del_atom_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pname</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">aprops</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.list_atom_properties"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.list_atom_properties">[docs]</a>    <span class="k">def</span> <span class="nf">list_atom_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">aprops</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No atom property&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Atom properties:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aprops</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.get_bond_property"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_bond_property">[docs]</a>    <span class="k">def</span> <span class="nf">get_bond_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pname</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bprops</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span></div>

<div class="viewcode-block" id="mol.set_bond_property"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_bond_property">[docs]</a>    <span class="k">def</span> <span class="nf">set_bond_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pname</span><span class="p">):</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="n">Property</span><span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nbonds</span><span class="p">,</span> <span class="s2">&quot;bonds&quot;</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pname</span><span class="p">,</span> <span class="n">prop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bprops</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pname</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.del_bond_property"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.del_bond_property">[docs]</a>    <span class="k">def</span> <span class="nf">del_bond_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pname</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">bprops</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.list_bond_properties"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.list_bond_properties">[docs]</a>    <span class="k">def</span> <span class="nf">list_bond_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bprops</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No bond property&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bond properties:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bprops</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.get_property"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.get_property">[docs]</a>    <span class="k">def</span> <span class="nf">get_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pname</span><span class="p">,</span> <span class="n">ptype</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ptype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;atom&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_atom_property</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ptype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;bond&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bond_property</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> property name: please use </span><span class="se">\&quot;</span><span class="s2">atom</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">bond</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pname</span><span class="p">)</span></div>

<div class="viewcode-block" id="mol.set_property"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.set_property">[docs]</a>    <span class="k">def</span> <span class="nf">set_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pname</span><span class="p">,</span> <span class="n">ptype</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ptype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;atom&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_atom_property</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ptype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;bond&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_bond_property</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> property name: please use </span><span class="se">\&quot;</span><span class="s2">atom</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">bond</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pname</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.del_property"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.del_property">[docs]</a>    <span class="k">def</span> <span class="nf">del_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pname</span><span class="p">,</span> <span class="n">ptype</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ptype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;atom&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">del_atom_property</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ptype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;bond&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">del_bond_property</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;No </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2"> property name: please use </span><span class="se">\&quot;</span><span class="s2">atom</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">bond</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pname</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.list_properties"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.list_properties">[docs]</a>    <span class="k">def</span> <span class="nf">list_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Properties:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_atom_properties</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_bond_properties</span><span class="p">()</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="mol.calc_uncorrected_bond_order"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.calc_uncorrected_bond_order">[docs]</a>    <span class="k">def</span> <span class="nf">calc_uncorrected_bond_order</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">iat</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">jat</span> <span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">bo_cut</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">):</span>
        <span class="c1"># Which elements do we have?</span>
        <span class="n">element_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elems</span><span class="p">()</span>
        <span class="c1"># sanity check(s)</span>
        <span class="n">eset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;c&quot;</span><span class="p">,</span><span class="s2">&quot;h&quot;</span><span class="p">,</span><span class="s2">&quot;o&quot;</span><span class="p">])</span>
        <span class="k">assert</span> <span class="nb">set</span><span class="p">(</span><span class="n">element_list</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">eset</span><span class="p">),</span> <span class="s2">&quot;Only C/H/O parameters&quot;</span>
        <span class="c1"># calculate distance of atoms i and j </span>
        <span class="n">rij</span><span class="p">,</span> <span class="n">rvec</span><span class="p">,</span> <span class="n">closest</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">get_distvec</span><span class="p">(</span><span class="n">iat</span><span class="p">,</span> <span class="n">jat</span><span class="p">)</span>
        <span class="c1"># receive atom type</span>
        <span class="n">itype</span> <span class="o">=</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">atom_type_to_num</span><span class="p">[</span><span class="n">element_list</span><span class="p">[</span><span class="n">iat</span><span class="p">]]</span>
        <span class="n">jtype</span> <span class="o">=</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">atom_type_to_num</span><span class="p">[</span><span class="n">element_list</span><span class="p">[</span><span class="n">jat</span><span class="p">]]</span>
        <span class="c1"># Get equilibrium bond distances</span>
        <span class="n">ro_s</span>   <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">r_s</span><span class="p">[</span><span class="n">itype</span><span class="p">]</span>   <span class="o">+</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">r_s</span><span class="p">[</span><span class="n">jtype</span><span class="p">]</span> <span class="p">)</span>   
        <span class="n">ro_pi</span>  <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">r_pi</span><span class="p">[</span><span class="n">itype</span><span class="p">]</span>  <span class="o">+</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">r_pi</span><span class="p">[</span><span class="n">jtype</span><span class="p">]</span> <span class="p">)</span>  
        <span class="n">ro_pi2</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">r_pi2</span><span class="p">[</span><span class="n">itype</span><span class="p">]</span> <span class="o">+</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">r_pi2</span><span class="p">[</span><span class="n">jtype</span><span class="p">]</span> <span class="p">)</span> 
        <span class="c1"># Calculate bond order</span>
        <span class="k">if</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">r_s</span><span class="p">[</span><span class="n">itype</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">r_s</span><span class="p">[</span><span class="n">jtype</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
          <span class="n">BO_s</span>    <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">bo_cut</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">pbo1</span><span class="p">[</span><span class="n">itype</span><span class="p">][</span><span class="n">jtype</span><span class="p">]</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">rij</span><span class="o">/</span><span class="n">ro_s</span><span class="p">,</span>   <span class="n">reaxparam</span><span class="o">.</span><span class="n">pbo2</span><span class="p">[</span><span class="n">itype</span><span class="p">][</span><span class="n">jtype</span><span class="p">])</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">BO_s</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">r_pi</span><span class="p">[</span><span class="n">itype</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">r_pi</span><span class="p">[</span><span class="n">jtype</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
          <span class="n">BO_pi</span>   <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">pbo3</span><span class="p">[</span><span class="n">itype</span><span class="p">][</span><span class="n">jtype</span><span class="p">]</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">rij</span><span class="o">/</span><span class="n">ro_pi</span><span class="p">,</span>  <span class="n">reaxparam</span><span class="o">.</span><span class="n">pbo4</span><span class="p">[</span><span class="n">itype</span><span class="p">][</span><span class="n">jtype</span><span class="p">])</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">BO_pi</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">r_pi2</span><span class="p">[</span><span class="n">itype</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">r_pi2</span><span class="p">[</span><span class="n">jtype</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
          <span class="n">BO_pi2</span>  <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">pbo5</span><span class="p">[</span><span class="n">itype</span><span class="p">][</span><span class="n">jtype</span><span class="p">]</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">rij</span><span class="o">/</span><span class="n">ro_pi2</span><span class="p">,</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">pbo6</span><span class="p">[</span><span class="n">itype</span><span class="p">][</span><span class="n">jtype</span><span class="p">])</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">BO_pi2</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">BO</span> <span class="o">=</span> <span class="n">BO_s</span> <span class="o">+</span> <span class="n">BO_pi</span> <span class="o">+</span> <span class="n">BO_pi2</span>
        <span class="k">if</span> <span class="n">BO</span> <span class="o">&gt;=</span> <span class="n">bo_cut</span><span class="p">:</span>
            <span class="n">BO</span> <span class="o">-=</span> <span class="n">bo_cut</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">BO</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">BO</span></div>

<div class="viewcode-block" id="mol.detect_conn_by_bo"><a class="viewcode-back" href="../../_api/molsys.html#molsys.mol.mol.detect_conn_by_bo">[docs]</a>    <span class="k">def</span> <span class="nf">detect_conn_by_bo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bo_cut</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">bo_thresh</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dist_thresh</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">correct</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">f2</span><span class="p">(</span><span class="n">di</span><span class="p">,</span><span class="n">dj</span><span class="p">):</span>
            <span class="n">lambda1</span> <span class="o">=</span> <span class="mf">50.0</span>
            <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambda1</span><span class="o">*</span><span class="n">di</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambda1</span><span class="o">*</span><span class="n">dj</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">f3</span><span class="p">(</span><span class="n">di</span><span class="p">,</span><span class="n">dj</span><span class="p">):</span>
            <span class="n">lambda2</span> <span class="o">=</span> <span class="mf">9.5469</span>
            <span class="n">expi</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambda2</span><span class="o">*</span><span class="n">di</span><span class="p">)</span>
            <span class="n">expj</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">lambda2</span><span class="o">*</span><span class="n">dj</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="n">lambda2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">expi</span><span class="o">+</span><span class="n">expj</span><span class="p">))</span> 
        <span class="k">def</span> <span class="nf">f1</span><span class="p">(</span><span class="n">di</span><span class="p">,</span><span class="n">dj</span><span class="p">,</span><span class="n">vali</span><span class="p">,</span><span class="n">valj</span><span class="p">):</span>
            <span class="n">f2val</span> <span class="o">=</span> <span class="n">f2</span><span class="p">(</span><span class="n">di</span><span class="p">,</span><span class="n">dj</span><span class="p">)</span>
            <span class="n">f3val</span> <span class="o">=</span> <span class="n">f3</span><span class="p">(</span><span class="n">di</span><span class="p">,</span><span class="n">dj</span><span class="p">)</span>
            <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">vali</span> <span class="o">+</span> <span class="n">f2val</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">vali</span> <span class="o">+</span> <span class="n">f2val</span> <span class="o">+</span> <span class="n">f3val</span><span class="p">)</span> 
                         <span class="o">+</span> <span class="p">(</span><span class="n">valj</span> <span class="o">+</span> <span class="n">f2val</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">valj</span> <span class="o">+</span> <span class="n">f2val</span> <span class="o">+</span> <span class="n">f3val</span><span class="p">)</span> 
                         <span class="p">)</span> 

        <span class="k">def</span> <span class="nf">f4</span><span class="p">(</span><span class="n">di</span><span class="p">,</span><span class="n">bij</span><span class="p">,</span><span class="n">lambda3</span><span class="p">,</span><span class="n">lambda4</span><span class="p">,</span><span class="n">lambda5</span><span class="p">):</span>
            <span class="n">exp_f4</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">lambda4</span><span class="o">*</span><span class="n">boij</span><span class="o">*</span><span class="n">boij</span><span class="o">-</span><span class="n">di</span><span class="p">)</span><span class="o">*</span><span class="n">lambda3</span> <span class="o">+</span> <span class="n">lambda5</span><span class="p">)</span>
            <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">exp_f4</span> <span class="p">)</span>

        <span class="n">element_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_elems</span><span class="p">()</span>
        <span class="n">natoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span>
        <span class="c1">#</span>
        <span class="c1"># calculate uncorrected bond order</span>
        <span class="c1">#</span>
        <span class="n">botab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">natoms</span><span class="p">,</span><span class="n">natoms</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">iat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
           <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">iat</span><span class="p">]</span>
           <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># distances from i to all other atoms</span>
           <span class="k">for</span> <span class="n">jat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">iat</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
              <span class="k">if</span> <span class="n">iat</span> <span class="o">!=</span> <span class="n">jat</span> <span class="ow">and</span> <span class="n">dist</span><span class="p">[</span><span class="n">jat</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dist_thresh</span><span class="p">:</span>
                  <span class="n">bo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_uncorrected_bond_order</span><span class="p">(</span><span class="n">iat</span><span class="p">,</span><span class="n">jat</span><span class="p">,</span><span class="n">bo_cut</span><span class="p">)</span> 
                  <span class="n">botab</span><span class="p">[</span><span class="n">iat</span><span class="p">][</span><span class="n">jat</span><span class="p">]</span> <span class="o">=</span> <span class="n">bo</span>
                  <span class="n">botab</span><span class="p">[</span><span class="n">jat</span><span class="p">][</span><span class="n">iat</span><span class="p">]</span> <span class="o">=</span> <span class="n">bo</span>   
        <span class="c1">## </span>
        <span class="c1"># correct bond order </span>
        <span class="c1">## </span>
        <span class="k">if</span> <span class="n">correct</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">natoms</span><span class="p">)</span>
            <span class="n">delta_boc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">natoms</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">iat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">iat</span><span class="p">]</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> 
                <span class="n">total_bo</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">jat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
                    <span class="c1">#if iat != jat and dist[jat] &lt;= dist_thresh and botab[iat][jat] &gt; bo_thresh:</span>
                    <span class="k">if</span> <span class="n">iat</span> <span class="o">!=</span> <span class="n">jat</span> <span class="ow">and</span> <span class="n">dist</span><span class="p">[</span><span class="n">jat</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dist_thresh</span> <span class="p">:</span>
                        <span class="n">total_bo</span> <span class="o">+=</span> <span class="n">botab</span><span class="p">[</span><span class="n">iat</span><span class="p">][</span><span class="n">jat</span><span class="p">]</span> 
                <span class="n">itype</span> <span class="o">=</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">atom_type_to_num</span><span class="p">[</span><span class="n">element_list</span><span class="p">[</span><span class="n">iat</span><span class="p">]]</span>
                <span class="n">delta</span><span class="p">[</span><span class="n">iat</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_bo</span> <span class="o">-</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">valency</span><span class="p">[</span><span class="n">itype</span><span class="p">]</span>
                <span class="n">delta_boc</span><span class="p">[</span><span class="n">iat</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_bo</span> <span class="o">-</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">valency_val</span><span class="p">[</span><span class="n">itype</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">iat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
                <span class="n">itype</span> <span class="o">=</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">atom_type_to_num</span><span class="p">[</span><span class="n">element_list</span><span class="p">[</span><span class="n">iat</span><span class="p">]]</span>
                <span class="n">vali</span> <span class="o">=</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">valency</span><span class="p">[</span><span class="n">itype</span><span class="p">]</span>
                <span class="n">di</span> <span class="o">=</span> <span class="n">delta</span><span class="p">[</span><span class="n">iat</span><span class="p">]</span>
                <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="n">iat</span><span class="p">]</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> 
                <span class="k">for</span> <span class="n">jat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">iat</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">boij</span> <span class="o">=</span> <span class="n">botab</span><span class="p">[</span><span class="n">iat</span><span class="p">][</span><span class="n">jat</span><span class="p">]</span>
                    <span class="n">jtype</span> <span class="o">=</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">atom_type_to_num</span><span class="p">[</span><span class="n">element_list</span><span class="p">[</span><span class="n">jat</span><span class="p">]]</span>
                    <span class="n">valj</span> <span class="o">=</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">valency</span><span class="p">[</span><span class="n">jtype</span><span class="p">]</span>
                    <span class="n">dj</span> <span class="o">=</span> <span class="n">delta</span><span class="p">[</span><span class="n">jat</span><span class="p">]</span>
                    <span class="n">pboc3</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">reaxparam</span><span class="o">.</span><span class="n">pboc3</span><span class="p">[</span><span class="n">itype</span><span class="p">]</span> <span class="o">*</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">pboc3</span><span class="p">[</span><span class="n">jtype</span><span class="p">])</span> 
                    <span class="n">pboc4</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">reaxparam</span><span class="o">.</span><span class="n">pboc4</span><span class="p">[</span><span class="n">itype</span><span class="p">]</span> <span class="o">*</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">pboc4</span><span class="p">[</span><span class="n">jtype</span><span class="p">])</span> 
                    <span class="n">pboc5</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">reaxparam</span><span class="o">.</span><span class="n">pboc5</span><span class="p">[</span><span class="n">itype</span><span class="p">]</span> <span class="o">*</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">pboc5</span><span class="p">[</span><span class="n">jtype</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">v13cor</span><span class="p">[</span><span class="n">itype</span><span class="p">][</span><span class="n">jtype</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.001</span><span class="p">:</span>
                        <span class="n">f4f5</span> <span class="o">=</span> <span class="n">f4</span><span class="p">(</span><span class="n">delta_boc</span><span class="p">[</span><span class="n">iat</span><span class="p">],</span><span class="n">boij</span><span class="p">,</span><span class="n">pboc3</span><span class="p">,</span><span class="n">pboc4</span><span class="p">,</span><span class="n">pboc5</span><span class="p">)</span> <span class="o">*</span> <span class="n">f4</span><span class="p">(</span><span class="n">delta_boc</span><span class="p">[</span><span class="n">jat</span><span class="p">],</span><span class="n">boij</span><span class="p">,</span><span class="n">pboc3</span><span class="p">,</span><span class="n">pboc4</span><span class="p">,</span><span class="n">pboc5</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="n">f4f5</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="k">if</span> <span class="n">reaxparam</span><span class="o">.</span><span class="n">ovc</span><span class="p">[</span><span class="n">itype</span><span class="p">][</span><span class="n">jtype</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.001</span><span class="p">:</span>
                        <span class="n">f1val</span> <span class="o">=</span> <span class="n">f1</span><span class="p">(</span><span class="n">di</span><span class="p">,</span><span class="n">dj</span><span class="p">,</span><span class="n">vali</span><span class="p">,</span><span class="n">valj</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">f1val</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">botab</span><span class="p">[</span><span class="n">iat</span><span class="p">][</span><span class="n">jat</span><span class="p">]</span> <span class="o">=</span> <span class="n">boij</span> <span class="o">*</span> <span class="n">f1val</span> <span class="o">*</span> <span class="n">f4f5</span> 
                    <span class="n">botab</span><span class="p">[</span><span class="n">jat</span><span class="p">][</span><span class="n">iat</span><span class="p">]</span> <span class="o">=</span> <span class="n">boij</span> <span class="o">*</span> <span class="n">f1val</span> <span class="o">*</span> <span class="n">f4f5</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># if bond order is above bo_thresh we consider the two atoms being bonded</span>
        <span class="k">for</span> <span class="n">iat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
           <span class="n">conn_local</span> <span class="o">=</span> <span class="p">[]</span>
           <span class="k">for</span> <span class="n">jat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natoms</span><span class="p">):</span>
              <span class="k">if</span> <span class="n">iat</span> <span class="o">!=</span> <span class="n">jat</span> <span class="ow">and</span> <span class="n">botab</span><span class="p">[</span><span class="n">iat</span><span class="p">][</span><span class="n">jat</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bo_thresh</span> <span class="p">:</span>
                  <span class="n">conn_local</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">jat</span><span class="p">)</span>
           <span class="n">conn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conn_local</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_conn</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">:</span>
            <span class="c1"># we had a pconn and redid the conn --&gt; need to reconstruct the pconn</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_pconn</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_ctab_from_conn</span><span class="p">(</span><span class="n">pconn_flag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_pconn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_etab_from_tabs</span><span class="p">()</span>
        <span class="k">return</span></div></div>

</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019-2021, Roberto Amabile, Johannes P. Duerholt, Julian Keupp, Rochus Schmid.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>